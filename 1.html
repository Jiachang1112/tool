<!DOCTYPE html> 
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æˆ‘çš„æ—¥è¨˜æœ¬ ğŸ“”</title>

  <!-- Faviconï¼ˆä¿®æ­£è·¯å¾‘ + ç‰ˆæœ¬è™Ÿæ›æˆ v=3 é€¼ç€è¦½å™¨æ›´æ–°ï¼‰ -->
<link rel="icon" href="./assets/img/journal-favicon.png?v=3" type="image/png" sizes="32x32">
<link rel="shortcut icon" href="./assets/img/journal-favicon.png?v=3" type="image/png">
<link rel="apple-touch-icon" href="./assets/img/journal-favicon.png?v=3">


  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

  <!-- [âœ… æ–°å¢] Google Maps Places APIï¼ˆè«‹æ›æˆä½ è‡ªå·±çš„ keyï¼‰ -->
  <script
    async
    defer
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places">
  </script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
    :root{ --primary:#7c3aed; }
    .primary-bg{ background: var(--primary) !important; }
    .primary-text{ color: var(--primary) !important; }
    .primary-border{ border-color: var(--primary) !important; }
    .switch{ position:relative;display:inline-block;width:44px;height:24px;}
    .switch input{opacity:0;width:0;height:0}
    .slider{ position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;transition:.2s;border-radius:999px;}
    .slider:before{ position:absolute;content:"";height:18px;width:18px;left:3px;top:3px;background:white;transition:.2s;border-radius:999px;}
    input:checked + .slider{ background: var(--primary); }
    input:checked + .slider:before{ transform: translateX(20px); }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    /* =========================
       Firebase åˆå§‹åŒ–
    ==========================*/
    const firebaseConfig = {
      apiKey: "AIzaSyCiho09ggVwKk96ItVof-iB38NrZkr_k5w",
      authDomain: "journal-49230.firebaseapp.com",
      projectId: "journal-49230",
      storageBucket: "journal-49230.appspot.com",
      messagingSenderId: "894572383995",
      appId: "1:894572383995:web:a41e4e58a5d3218fee6a5e"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } else { firebase.app(); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    /* =========================
       å·¥å…·
    ==========================*/
    const Icon = ({ name, className="w-5 h-5", fill=false }) => {
      const P = {
        search:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
        plus:"M12 4v16m8-8H4",
        calendar:"M8 2v4m8-4v4M3 10h18M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z",
        heart:"M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z",
        lock:"M5 11h14a2 2 0 012 2v7a2 2 0 01-2 2H5a2 2 0 01-2-2v-7a2 2 0 012-2zm2-4a5 5 0 0110 0v4H7V7z",
        trash:"M3 6h18m-2 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2m-6 5v6m4-6v6",
        edit:"M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z",
        save:"M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z",
        x:"M6 18L18 6M6 6l12 12",
        moon:"M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z",
        sun:"M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41M12 6a6 6 0 100 12 6 6 0 000-12z",
        download:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m4-5l5 5m0 0l5-5m-5 5V3",
        user:"M12 12a5 5 0 100-10 5 5 0 000 10zm7 10H5a7 7 0 0114 0z",
        import:"M12 5v10m0 0l-4-4m4 4l4-4M5 19h14",
        bell:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-9.33-4.93M13 21a2 2 0 01-4 0",
        image:"M3 19a2 2 0 002 2h14a2 2 0 002-2V7a2 2 0 00-2-2h-6l-2-2H5a2 2 0 01-2 2v14zm3-3l4-4 3 3 4-4 2 2v4H6z",
        gear:"M13.8,12c0,1-0.8,1.8-1.8,1.8s-1.8-0.8-1.8-1.8s0.8-1.8,1.8-1.8S13.8,11,13.8,12z M19.4,12c0-0.4-0.3-0.8-0.8-0.8h-2.1 c-0.2-0.6-0.5-1.2-0.9-1.7l1.5-1.5c0.3-0.3,0.3-0.8,0-1.1l-1.2-1.2c-0.3-0.3-0.8-0.3-1.1,0l-1.5,1.5c-0.5-0.4-1.1-0.7-1.7-0.9v-2.1 c0-0.4-0.3-0.8-0.8-0.8h-1.8c-0.4,0-0.8,0.3-0.8,0.8v2.1c-0.6,0.2-1.2,0.5-1.7,0.9l-1.5-1.5c-0.3-0.3-0.8-0.3-1.1,0l-1.2,1.2 c-0.3,0.3-0.8,0.3-1.1,0l-1.5-1.5c-0.4,0.5-0.7,1.1-0.9,1.7H5.4c-0.4,0-0.8,0.3-0.8,0.8v1.8c0,0.4,0.3,0.8,0.8,0.8h2.1 c0.2,0.6,0.5,1.2,0.9,1.7l-1.5,1.5c-0.3,0.3-0.3,0.8,0,1.1l1.2,1.2c0.3,0.3,0.8,0.3,1.1,0l1.5-1.5c0.5,0.4,1.1,0.7,1.7,0.9v2.1 c0,0.4,0.3,0.8,0.8,0.8h1.8c0.4,0,0.8-0.3,0.8-0.8v-2.1c0.6-0.2,1.2-0.5,1.7-0.9l1.5,1.5c0.3,0.3,0.8,0.3,1.1,0l1.2-1.2 c0.3-0.3,0.3-0.8,0,1.1l-1.5-1.5c0.4-0.5,0.7-1.1,0.9-1.7h2.1c0.4,0,0.8-0.3,0.8-0.8V12z",
        star:"M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z",
        trophy:"M17 3h4v2a5 5 0 01-5 5h-1a6 6 0 11-12 0V3h4",
        menu: "M3 12h18M3 6h18M3 18h18",
        archive: "M21 8v13H3V8M1 3h22v5H1zM10 12h4",
        'refresh-ccw': "M1 4v6h6M23 20v-6h-6M20.49 9A9 9 0 0 0 3.51 9M3.51 15a9 9 0 0 0 16.98 0",
        scissors: "M6 6a2 2 0 0 1 4 0v4L6 14V6zm12 0a2 2 0 0 0-4 0v4l4 4V6zM8 8H4M16 8h4M8 12l-4 4 4 4M16 12l4 4-4 4",
        share: "M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13",
        chart:"M12 20V10M18 20V4M6 20v-4",
        // [âœ… å·²æœ‰] åœ°åœ–åœ–ç¤º
        "map-pin": "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0zM12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"
      };
      return React.createElement('svg', {
        className,
        fill: name === 'gear' ? 'currentColor' : (fill ? 'currentColor' : 'none'),
        stroke: name === 'gear' ? 'none' : (fill ? 'none' : 'currentColor'),
        strokeWidth: name === 'gear' ? '0' : '2',
        strokeLinecap:'round', strokeLinejoin:'round', viewBox:'0 0 24 24'
      }, React.createElement('path',{ d: P[name] }));
    };

    const moods = ['ğŸ˜Š','ğŸ˜¢','ğŸ˜¡','ğŸ˜°','ğŸ˜','ğŸ¤”','ğŸ˜´','ğŸ‰'];
    const weathers = ['â˜€ï¸','â›…','â˜ï¸','ğŸŒ§ï¸','â›ˆï¸','ğŸŒˆ','â„ï¸','ğŸŒ™'];
    const allTags = ['ç”Ÿæ´»','å·¥ä½œ','æ—…éŠ','å­¸ç¿’','å¥åº·','äººéš›é—œä¿‚','èˆˆè¶£'];

    /* [âœ… æ–°å¢] å°ç£ç¸£å¸‚æ¸…å–® */
    const TAIWAN_COUNTIES = [
      'è‡ºåŒ—å¸‚','æ–°åŒ—å¸‚','æ¡ƒåœ’å¸‚','è‡ºä¸­å¸‚','è‡ºå—å¸‚','é«˜é›„å¸‚',
      'åŸºéš†å¸‚','æ–°ç«¹å¸‚','æ–°ç«¹ç¸£','è‹—æ —ç¸£','å½°åŒ–ç¸£','å—æŠ•ç¸£',
      'é›²æ—ç¸£','å˜‰ç¾©å¸‚','å˜‰ç¾©ç¸£','å±æ±ç¸£','å®œè˜­ç¸£','èŠ±è“®ç¸£',
      'è‡ºæ±ç¸£','æ¾æ¹–ç¸£','é‡‘é–€ç¸£','é€£æ±Ÿç¸£'
    ];

    /* [âœ… æ–°å¢] ç­‰å¾… Google Maps è®€å– Places Library */
    function waitForGoogleMaps(maxWait = 8000) {
      return new Promise((resolve, reject) => {
        if (window.google?.maps?.places) return resolve(window.google);
        const start = Date.now();
        const timer = setInterval(() => {
          if (window.google?.maps?.places) {
            clearInterval(timer);
            resolve(window.google);
          } else if (Date.now() - start > maxWait) {
            clearInterval(timer);
            reject(new Error('Google Maps è¼‰å…¥é€¾æ™‚'));
          }
        }, 100);
      });
    }

    /* æ—¥æœŸå·¥å…· (åŸå°ä¸å‹•) */
    const toDate = (val) => {
      try {
        if (!val) return null;
        if (val instanceof Date) return isNaN(val.getTime()) ? null : val;
        if (typeof val === 'object' && typeof val.toDate === 'function') {
          const d = val.toDate(); return isNaN(d.getTime()) ? null : d;
        }
        const d = new Date(val);
        return isNaN(d.getTime()) ? null : d;
      } catch { return null; }
    };
    const localDateKey = (d) => {
      if (!(d instanceof Date) || isNaN(d.getTime())) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };

    // æ—¥æœŸæ ¼å¼åŒ–å·¥å…·
    const toDateTimeLocal = (isoString) => {
      if (!isoString) return '';
      try {
        const date = new Date(isoString);
        if (isNaN(date.getTime())) return '';
        const tzoffset = (new Date()).getTimezoneOffset() * 60000;
        const localISOTime = (new Date(date.getTime() - tzoffset)).toISOString().slice(0, 16);
        return localISOTime;
      } catch (e) {
        return '';
      }
    };

    /* SHA-256 (åŸå°ä¸å‹•) */
    async function sha256Hex(text){
      try{
        // ç§»é™¤ä¸å†éœ€è¦çš„åº§æ¨™æ¬„ä½
    delete formData.locationLat;
    delete formData.locationLng;
        const enc = new TextEncoder().encode(text);
        const buf = await crypto.subtle.digest('SHA-256', enc);
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(e){
        return `plain:${text}`;
      }
    }
    
    {/* Firebase Storage åœ–ç‰‡ä¸Šå‚³å·¥å…· (åŸå°ä¸å‹•) */}
    const uploadFileToStorage = async (file, userId) => {
      if (!userId) { throw new Error("User not authenticated for upload."); }
      const storageRef = storage.ref();
      const fileExtension = file.name.split('.').pop();
      const fileName = `${userId}/${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExtension}`;
      const imageRef = storageRef.child(fileName);
      const snapshot = await imageRef.put(file);
      return snapshot.ref.getDownloadURL();
    };


    /* Streak (åŸå°ä¸å‹•) */
    function calcStreak(diaries){
      const set = new Set();
      diaries.forEach(d=>{
        const dt = toDate(d.createdAt); if(!dt) return;
        set.add(localDateKey(dt));
      });
      if(set.size===0) return { streak:0, best:0, hasToday:false };

      const keys = Array.from(set).sort();
      let best = 1, cur = 1;
      for(let i=1;i<keys.length;i++){
        const prev = new Date(keys[i-1]);
        const now  = new Date(keys[i]);
        const diff = Math.round((now - prev)/86400000);
        if(diff===1){ cur++; best=Math.max(best,cur); }
        else if(diff>1){ cur=1; }
      }

      const todayKey = localDateKey(new Date());
      const hasToday = set.has(todayKey);
      let streak = 0; let probe = new Date();
      while(set.has(localDateKey(probe))){ streak++; probe.setDate(probe.getDate()-1); }

      return { streak, best, hasToday };
    }
    const StreakBadge = ({ diaries }) => {
      const { streak, best, hasToday } = useMemo(()=>calcStreak(diaries), [diaries]);
      const daySet = useMemo(()=>{
        const s = new Set();
        diaries.forEach(d=>{
          const dt = toDate(d.createdAt);
          if (dt) s.add(localDateKey(dt));
        });
        return s;
      }, [diaries]);
      const week = useMemo(()=>{
        const today = new Date();
        const offset = (today.getDay()+6)%7;
        const monday = new Date(today);
        monday.setDate(today.getDate() - offset);
        const days = [];
        for (let i=0;i<7;i++){
          const d = new Date( monday);
          d.setDate(monday.getDate()+i);
          days.push(d);
        }
        return days;
      }, []);
      const wcn = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
      const tier =
        streak >= 30 ? { name:'ç«ç„°å‚³å¥‡', icon:'trophy' } :
        streak >= 7  ? { name:'å …æŒä¹‹ç«', icon:'calendar' } :
        streak >= 3  ? { name:'èµ·æ­¥ä¹‹æ˜Ÿ', icon:'heart' } :
                       { name:'åŠ æ²¹æ‰“æ°£', icon:'star' };
      const tip = hasToday ? 'å·²å®Œæˆä»Šæ—¥æ‰“å¡ï¼' : 'ä»Šå¤©é‚„æ²’å¯«å–”ï½';

      return (
        <div className="flex items-center gap-4 px-4 py-3 rounded-2xl border bg-white/80 shadow flex-wrap">
          <div className="flex items-center gap-3">
            <Icon name={tier.icon} className="w-7 h-7 primary-text" fill />
            <div>
              <div className="text-sm text-gray-500">é€£çºŒå¤©æ•¸</div>
              <div className="text-2xl font-extrabold">
                {streak} å¤© <span className="ml-2 text-xs font-medium text-gray-500">(æœ€ä½³ {best})</span>
              </div>
              <div className="text-xs text-gray-500">{tip}</div>
            </div>
            <span className="ml-2 px-2 py-1 text-xs rounded-full primary-bg text-white">{tier.name}</span>
          </div>
          <div className="ml-auto">
            <div className="flex items-center justify-between text-xs text-gray-500 mb-1 select-none">
              {wcn.map((t, i)=>(<div key={i} className="w-8 text-center">{t}</div>))}
            </div>
            <div className="flex items-center justify-between">
              {week.map((d, i)=>{
                const key = localDateKey(d);
                const checked = daySet.has(key);
                return (
                  <div key={i} className="w-8 h-8 rounded-full border-2 flex items-center justify-center"
                       style={{ borderColor: checked ? 'var(--primary)' : '#cbd5e1',
                                background: checked ? 'var(--primary)' : 'transparent' }}>
                    {checked ? (
                      <svg viewBox="0 0 24 24" className="w-4 h-4 text-white" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M20 6L9 17l-5-5"/>
                      </svg>
                    ) : null}
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    };

    /* ç™»å…¥å…ƒä»¶ (AuthBar) [åŸå°ä¸å‹•æ–¼åŠŸèƒ½ï¼Œåªæ˜¯ä¿ç•™æˆ‘å€‘å·²æœ‰ä¿®æ”¹] */
    const AuthBar = ({ user }) => {
      const [show, setShow] = useState(false);
      const [isSignup, setIsSignup] = useState(false);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [displayName, setDisplayName] = useState('');
      const provider = useMemo(()=>new firebase.auth.GoogleAuthProvider(),[]);
      
      const closeModal = () => {
        setShow(false);
        setEmail('');
        setPassword('');
        setDisplayName('');
      };

      const submit = async () => {
        try{
          if(isSignup){
            if (!displayName.trim()) {
              alert('è«‹è¼¸å…¥ä½ çš„åå­—');
              return;
            }
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            if (userCredential.user) {
              await userCredential.user.updateProfile({
                displayName: displayName.trim()
              });
            }
          } else {
            await auth.signInWithEmailAndPassword(email, password);
          }
          closeModal();
        }catch(e){ alert('Auth Error: '+e.message); }
      };
      
      const google = async () => {
        try{ 
          await auth.signInWithPopup(provider); 
          closeModal();
        }
        catch(e){ alert('Google ç™»å…¥å¤±æ•—ï¼š'+e.message); }
      };

      return (
        <div className="flex items-center gap-3">
          {user ? (
            <>
              <div className="flex items-center gap-2 px-3 py-1 rounded-lg bg-white/70">
                <Icon name="user" />
                <span className="text-sm" title={user.displayName || user.email}>{user.displayName || user.email}</span>
              </div>
              <button onClick={()=>auth.signOut()} className="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300">ç™»å‡º</button>
            </>
          ):(
            <>
              <button onClick={()=>{setIsSignup(false);setShow(true);}} className="px-3 py-1 rounded-lg primary-bg text-white">ç™»å…¥</button>
              <button onClick={()=>{setIsSignup(true);setShow(true);}} className="px-3 py-1 rounded-lg bg-gray-800 text-white">è¨»å†Š</button>
            </>
          )}

          {show && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
              <div className="bg-white rounded-2xl shadow-xl p-6 w-[90%] max-w-md">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-xl font-bold">{isSignup?'å»ºç«‹å¸³è™Ÿ':'ç™»å…¥'}</h3>
                  <button onClick={closeModal} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="x"/></button>
                </div>
                <div className="space-y-3">
                  {isSignup && (
                    <input value={displayName} onChange={e=>setDisplayName(e.target.value)} placeholder="ä½ çš„åå­—"
                           className="w-full border rounded-lg p-2"/>
                  )}
                  <input value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email"
                         className="w-full border rounded-lg p-2"/>
                  <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="å¯†ç¢¼"
                         className="w-full border rounded-lg p-2"/>
                  <button onClick={submit} className="w-full primary-bg text-white rounded-lg py-2">{isSignup?'è¨»å†Š':'ç™»å…¥'}</button>
                  <button onClick={google} className="w-full bg-red-500 hover:bg-red-600 text-white rounded-lg py-2">ä½¿ç”¨ Google</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    /* æé†’æœå‹™ (åŸå°ä¸å‹•) */
    const ReminderService = {
      key: 'diary_reminders_v2',
      load(){ try{ return JSON.parse(localStorage.getItem(this.key)||'[]'); }catch{ return [] } },
      save(list){ localStorage.setItem(this.key, JSON.stringify(list)); },
      add(rem){ const list=this.load(); list.push(rem); this.save(list); },
      remove(id){ const list=this.load().filter(r=>r.id!==id); this.save(list); },
      _nextTime(cur, freq){
        if(freq==='DAILY'){ const d = new Date(cur); d.setDate(d.getDate()+1); return d; }
        if(freq==='WEEKLY'){ const d = new Date(cur); d.setDate(d.getDate()+7); return d; }
        return null;
      },
      scheduleTicker(){
        setInterval(()=>{
          let list = this.load(); const now = Date.now(); let dirty = false;
          for(const r of list){
            const due = new Date(r.at).getTime();
            if(now >= due){
              if(Notification?.permission==='granted'){ new Notification('æ—¥è¨˜æé†’', { body: r.title || 'è©²å¯«æ—¥è¨˜æˆ–æŸ¥çœ‹å‚™å¿˜å›‰ï¼' }); }
              if(r.freq && r.freq!=='ONCE'){
                const next = this._nextTime(new Date(r.at), r.freq);
                if(next){ r.at = next.toISOString(); r.fired = false; dirty = true; }
              }else{ r.fired = true; dirty = true; }
            }
          }
          const keep = list.filter(r => !(r.fired && (!r.freq || r.freq==='ONCE')));
          if(dirty || keep.length !== list.length){ this.save(keep); }
        }, 15000);
      },
      requestPermission(){
        if('Notification' in window && Notification.permission!=='granted'){ Notification.requestPermission(); }
      }
    };

    /* Tag Cloud (åŸå°ä¸å‹•) */
    const TagCloud = ({ diaries, activeTag, onToggle }) => {
      const map = {}; diaries.forEach(d => (d.tags||[]).forEach(t => map[t]=(map[t]||0)+1));
      const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
      if(entries.length===0) return <p className="text-gray-400">é‚„æ²’æœ‰æ¨™ç±¤</p>;
      
      return (
        <div className="flex flex-wrap gap-2">
          {entries.map(([tag,count])=>{
            const active = activeTag===tag;
            return (
              <button key={tag}
                onClick={()=>onToggle(tag)}
                className={`px-3 py-1 rounded-lg text-sm transition ${active?'primary-bg text-white':'bg-gray-100 hover:bg-gray-200'}`}
                title={`#${tag} Ã—${count}`}
              >#{tag}</button>
            );
          })}
        </div>
      );
    };
    
    // CalendarView (åŸå°ä¸å‹•)
    const CalendarView = ({ diaries, onPickDate }) => {
      const [cur, setCur] = useState(new Date());
      const y = cur.getFullYear(), m = cur.getMonth();
      const first = new Date(y,m,1);
      const startDay = (first.getDay()+6)%7;
      const daysInMonth = new Date(y,m+1,0).getDate();
      const setMonth = (delta)=>{ const d=new Date(y,m+delta,1); setCur(d); };

      const hasMap = {};
      diaries.forEach(d=>{
        const dt = toDate(d.createdAt);
        if (dt) { const day = localDateKey(dt); if (day) hasMap[day] = (hasMap[day]||0)+1; }
      });

      const cells=[]; for(let i=0;i<startDay;i++) cells.push(null);
      for(let d=1; d<=daysInMonth; d++) cells.push(new Date(y,m,d));

      return (
        <div className="border rounded-2xl p-4 bg-white/80 shadow">
          <div className="flex items-center justify-between mb-2">
            <button onClick={()=>setMonth(-1)} className="px-2 py-1 rounded-lg bg-gray-100 hover:bg-gray-200">â€¹</button>
            <div className="font-bold text-xl">{y} å¹´ {m+1} æœˆ</div>
            <button onClick={()=>setMonth(1)} className="px-2 py-1 rounded-lg bg-gray-100 hover:bg-gray-200">â€º</button>
          </div>
          <div className="grid grid-cols-7 gap-1 text-center text-sm font-semibold text-gray-700 mb-1">
            {['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map(d=><div key={d}>{d}</div>)}
          </div>
          <div className="grid grid-cols-7 gap-1">
            {cells.map((d,i)=>{
              if(!d) return <div key={i} className="h-20"></div>;
              const key = localDateKey(d);
              const count = hasMap[key]||0;
              
              const btnClasses = 'h-20 rounded-xl text-sm';

              return (
                <button key={i}
                  onClick={()=>onPickDate(key)}
                  className={`${btnClasses} relative flex items-center justify-center border transition hover:shadow-md ${
                    count? 'primary-border border-2 bg-purple-50':'border-gray-200 bg-white'
                  }`}
                >
                  <div className="absolute top-1 left-1 text-sm">{d.getDate()}</div>
                  {count>0 && (
                    <div className="absolute bottom-1 right-1 text-xs px-1 py-0.5 rounded-full primary-bg text-white">
                      {count}
                    </div>
                  )}
                </button>
              );
            })}
          </div>
          <div className="mt-4 text-center text-sm text-gray-600">
            é»æ“Šæ—¥æœŸï¼š<span className="font-semibold">ç¯©é¸ç•¶æ—¥æ—¥è¨˜</span>
          </div>
        </div>
      );
    };

    const Charts = ({ diaries, darkMode }) => {
      const moodRef  = useRef(null);
      const dailyRef = useRef(null);
      const moodChart  = useRef(null);
      const dailyChart = useRef(null);
      const getPrimary = () =>
        getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#7c3aed';
      const rgba = (hex, a=1)=>{
        const h = hex.replace('#','');
        const bigint = parseInt(h.length===3 ? h.split('').map(x=>x+x).join('') : h,16);
        const r=(bigint>>16)&255, g=(bigint>>8)&255, b=(bigint)&255;
        return `rgba(${r},${g},${b},${a})`;
      };
      const moodsArr = ['ğŸ˜Š','ğŸ˜¢','ğŸ˜¡','ğŸ˜°','ğŸ˜','ğŸ¤”','ğŸ˜´','ğŸ‰'];
      const moodCounts = useMemo(()=>{
        const map = Object.fromEntries(moodsArr.map(m=>[m,0]));
        diaries.forEach(d => map[d.mood]=(map[d.mood]||0)+1);
        return map;
      }, [diaries]);
      const dailyCounts = useMemo(()=>{
        const map = {};
        diaries.forEach(d=>{
          const dt = toDate(d.createdAt);
          if (dt) {
            const k = localDateKey(dt);
            map[k] = (map[k]||0)+1;
          }
        });
        const keys = Object.keys(map).sort();
        return { labels: keys, data: keys.map(k=>map[k]) };
      }, [diaries]);
      const centerTextPlugin = {
        id: 'centerText',
        afterDraw(chart, args, opts){
          const {ctx, chartArea:{width,height}} = chart;
          if(!opts?.text) return;
          ctx.save();
          ctx.font = `600 ${opts.fontSize||20}px system-ui, -apple-system`;
          ctx.fillStyle = opts.color||'#111';
          ctx.textAlign='center';
          ctx.textBaseline='middle';
          ctx.fillText(opts.text, width/2, height/2);
          ctx.restore();
        }
      };
      useEffect(()=>{
        moodChart.current?.destroy();
        dailyChart.current?.destroy();
        const primary = getPrimary();
        const moodData = Object.values(moodCounts);
        const total = moodData.reduce((a,b)=>a+b,0);
        const donutColors = [
          rgba(primary, .9), rgba('#ef4444', .8), rgba('#f59e0b', .8), rgba('#06b6d4', .8),
          rgba('#a855f7', .85), rgba('#10b981', .8), rgba('#9ca3af', .8), rgba('#3b82f6', .8)
        ];
        moodChart.current = new Chart(moodRef.current, {
          type:'doughnut',
          data:{
            labels: Object.keys(moodCounts),
            datasets:[{
              data: moodData,
              backgroundColor: donutColors.slice(0, moodData.length),
              borderWidth: 0,
              hoverOffset: 8,
              spacing: 2
            }]
          },
          options:{
            cutout: '65%',
            plugins:{
              legend:{ display:false },
              tooltip:{
                backgroundColor: rgba('#111827', .9),
                titleColor:'#fff', bodyColor:'#fff',
                padding:12, cornerRadius:10,
                callbacks:{
                  label(ctx){
                    const v = ctx.parsed;
                    const p = total? Math.round(v/total*100):0;
                    return `  ${v} ç¯‡ï¼ˆ${p}%ï¼‰`;
                  }
                }
              }
            },
            animation:{ duration:800, easing:'easeOutQuart' }
          },
          plugins:[centerTextPlugin],
        });
        moodChart.current.options.plugins.centerText = {
          text: total ? `å…± ${total} ç¯‡` : 'å°šç„¡è³‡æ–™',
          color: darkMode? '#e5e7eb':'#374151',
          fontSize: 16
        };
        moodChart.current.update();
        const labels = dailyCounts.labels.map(s=>{
          const [y,m,d] = s.split('-');
          return `${m}/${d}`;
        });
        const gridColor = darkMode? rgba('#ffffff', .1) : rgba('#000000', .06);
        dailyChart.current = new Chart(dailyRef.current, {
          type:'bar',
          data:{
            labels,
            datasets:[{
              label:'æ¯æ—¥ç¯‡æ•¸',
              data: dailyCounts.data,
              backgroundColor: rgba(primary, .35),
              borderColor: rgba(primary, .9),
              borderWidth: 1.5,
              borderRadius: 8,
              barPercentage: .6,
              categoryPercentage: .7
            }]
          },
          options:{
            maintainAspectRatio: false,
            scales:{
              x:{
                grid:{ display:false },
                ticks:{
                  color: darkMode?'#fff':'#111',
                  maxRotation: 0,
                  autoSkip: true
                }
              },
              y:{
                beginAtZero:true,
                grid:{ color: gridColor, drawBorder:false },
                ticks:{ color: darkMode?'#fff':'#111', stepSize: 1 }
              }
            },
            plugins:{
              legend:{ display:false },
              tooltip:{
                backgroundColor: rgba('#111827', .9),
                titleColor:'#fff', bodyColor:'#fff',
                padding:12, cornerRadius:10
              }
            },
            layout:{ padding: { top: 6, right: 10, left: 6, bottom: 0 } },
            animation:{ duration:700, easing:'easeOutCubic' }
          }
        });
        return ()=>{ moodChart.current?.destroy(); dailyChart.current?.destroy(); }
      }, [moodCounts, dailyCounts, darkMode]);
      const total = diaries.length || 0;
      const happy = moodCounts['ğŸ˜Š']||0;
      return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className={`${darkMode?'bg-gray-800':'bg-white'} rounded-2xl shadow p-4`}>
            <h4 className="font-bold mb-2">å¿ƒæƒ…åˆ†ä½ˆ</h4>
            <div style={{height: 320}}>
              <canvas ref={moodRef}></canvas>
            </div>
            <div className="mt-3 text-sm text-gray-500">å…± {total} ç¯‡ï¼ŒğŸ˜Š {happy} ç¯‡</div>
          </div>
          <div className={`${darkMode?'bg-gray-800':'bg-white'} rounded-2xl shadow p-4`}>
            <h4 className="font-bold mb-2">æ¯æ—¥ç¯‡æ•¸</h4>
            <div style={{height: 320}}>
              <canvas ref={dailyRef}></canvas>
            </div>
          </div>
        </div>
      );
    };

    /* é‡‘é¡æŠ˜æŠµå·¥å…· (åŸå°ä¸å‹•) */
    const prices = { monthly: 150, yearly: 1500 };
    function priceAfterDiscount(price, coupon){
      if(!coupon) return price;
      const off = Math.max(0, Number(coupon.discountAmount||0));
      return Math.max(0, price - off);
    }

    /* Premium Modal (åŸå°ä¸å‹•) */
    const PremiumModal = ({
      open, onClose, onApplyCoupon, onClearCoupon, onPurchase,
      membership, user, appliedCoupon, selectedPlan, setSelectedPlan
    }) => {
      const [code, setCode] = useState('');
      if(!open) return null;
      const expiresText = (() => {
        const dt = toDate(membership?.expiresAt);
        return dt ? dt.toLocaleDateString('zh-TW') : null;
      })();

      const basePrice = selectedPlan==='yearly' ? prices.yearly : prices.monthly;
      const due = priceAfterDiscount(basePrice, appliedCoupon);
      const off = Math.max(0, basePrice - due);

      return (
        <div className="fixed inset-0 bg-black/40 flex items-end sm:items-center justify-center z-50">
          <div className="bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl w-full max-w-lg">
            <div className="p-4 border-b flex items-center justify-between">
              <div className="font-bold text-lg">Get Premium</div>
              <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="x"/></button>
            </div>
            <div className="p-5 space-y-5">
              <div className="grid grid-cols-2 gap-2">
                <button
                  onClick={()=>setSelectedPlan('monthly')}
                  className={`rounded-xl border p-4 text-left ${selectedPlan==='monthly'?'border-2 primary-border bg-purple-50':''}`}
                >
                  <div className="text-xl font-bold mb-1">æœˆè²»</div>
                  <div className="text-3xl font-extrabold mb-2 primary-text">NT$ {prices.monthly}</div>
                  <ul className="list-disc pl-5 text-sm text-gray-600 space-y-1">
                    <li>é›²ç«¯å‚™ä»½</li><li>åœ–ç‰‡ä¸Šå‚³</li><li>æ›´å¤šçµ±è¨ˆ</li>
                  </ul>
                </button>
                <button
                  onClick={()=>setSelectedPlan('yearly')}
                  className={`rounded-xl border p-4 text-left ${selectedPlan==='yearly'?'border-2 primary-border bg-purple-50':''}`}
                >
                  <div className="text-xl font-bold mb-1">å¹´è²»</div>
                  <div className="text-3xl font-extrabold mb-2 primary-text">NT$ {prices.yearly}</div>
                  <ul className="list-disc pl-5 text-sm text-gray-600 space-y-1">
                    <li>åŠŸèƒ½åŒæœˆè²»</li><li>æ›´åˆ’ç®—ï¼ˆ12 å€‹æœˆï¼‰</li>
                  </ul>
                </button>
              </div>
              <div className="rounded-xl border p-4">
                <div className="font-semibold mb-2">å„ªæƒ åˆ¸</div>
                <div className="flex gap-2">
                  <input value={code} onChange={e=>setCode(e.target.value)} placeholder="è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼"
                         className="flex-1 border rounded-lg p-2"/>
                  <button onClick={()=>onApplyCoupon(code)} className="px-3 py-2 rounded-lg border hover:bg-gray-50">å¥—ç”¨</button>
                  {appliedCoupon && (
                    <button onClick={onClearCoupon} className="px-3 py-2 rounded-lg border hover:bg-gray-50 text-red-600">æ¸…é™¤</button>
                  )}
                </div>
                {appliedCoupon && (
                  <div className="text-sm text-green-700 mt-2">
                    å·²å¥—ç”¨ï¼š<span className="font-semibold">{appliedCoupon.code}</span> Â· æŠ˜æŠµé‡‘é¡ NT$ {Number(appliedCoupon.discountAmount||0)}
                  </div>
                )}
              </div>
              <div className="rounded-xl border p-4 bg-gray-50">
                <div className="flex items-center justify-between text-sm">
                  <span>æ–¹æ¡ˆåŸåƒ¹</span><span>NT$ {basePrice}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span>æŠ˜æŠµ</span><span className={`${off>0?'text-green-700':''}`}>-{off}</span>
                </div>
                <div className="mt-2 border-t pt-2 flex items-center justify-between font-bold text-lg">
                  <span>æ‡‰ä»˜é‡‘é¡</span><span className="primary-text">NT$ {due}</span>
                </div>
              </div>
              <div className="text-sm text-gray-600">
                ç›®å‰ç­‰ç´šï¼š<span className="font-semibold">{membership?.tier || 'free'}</span>
                {expiresText && <> Â· åˆ°æœŸï¼š<span className="font-semibold">{expiresText}</span></>}
                {!user && <div className="text-red-600 mt-1">è«‹å…ˆç™»å…¥ä»¥å®Œæˆå‡ç´š</div>}
              </div>
              <button
                onClick={()=>onPurchase(selectedPlan, appliedCoupon, basePrice, due)}
                className="w-full primary-bg text-white rounded-lg py-3"
              >
                ç«‹å³å‡ç´šï¼ˆæ‡‰ä»˜ NT$ {due}ï¼‰
              </button>
            </div>
          </div>
        </div>
      );
    };

    /* è¨­å®šé¢æ¿ (åŸå°ä¸å‹•) */
    const SettingsPanel = ({
      open, onClose,
      exportDiaries, importDiaries,
      themeColor, setThemeColor,
      reminders, onAddReminder, onRemoveReminder,
      profile, isAdmin, onCreateCoupon, onApplyCoupon,
      membership, onSetMembershipTier,
      onBackupToStorage, onRestoreFromStorage,
      todayShortcut, toggleFavoritesOnly, favoritesOnly,
      darkMode, setDarkMode, user
    })=>{
      const [title,setTitle] = useState('');
      const [when,setWhen]   = useState('');
      const [freq,setFreq]   = useState('ONCE');
      const [couponCode,setCouponCode] = useState('');
      const [newCoupon, setNewCoupon]  = useState({
        code:'', months:1, active:true, discountAmount: 0
      });
      const [privPwdInput, setPrivPwdInput] = useState('');
      const [privPwdVisible, setPrivPwdVisible] = useState(false);
      useEffect(()=>{ setPrivPwdInput(''); }, [open]);
      
      const [activeTab, setActiveTab] = useState('personal');

      if(!open) return null;
      const membershipExpireText = (() => {
        const dt = toDate(membership?.expiresAt);
        return dt ? dt.toLocaleDateString('zh-TW') : 'â€”';
      })();
      const currentHashed = profile?.privatePasswordHash || localStorage.getItem('privatePasswordHash') || '';
      const savePrivatePwd = async ()=>{
        if(!privPwdInput){ alert('è«‹å…ˆè¼¸å…¥å¯†ç¢¼'); return; }
        const hashed = await sha256Hex(privPwdInput);
        if(user){
          await db.collection('users').doc(user.uid).set({ privatePasswordHash: hashed }, { merge:true });
        }else{
          localStorage.setItem('privatePasswordHash', hashed);
        }
        alert('ç§å¯†æ—¥è¨˜å¯†ç¢¼å·²è¨­å®š âœ…');
        setPrivPwdInput('');
      };
      const clearPrivatePwd = async ()=>{
        if(user){
          await db.collection('users').doc(user.uid).set({ privatePasswordHash: firebase.firestore.FieldValue.delete() }, { merge:true });
        }else{
          localStorage.removeItem('privatePasswordHash');
        }
        alert('å·²æ¸…é™¤ç§å¯†æ—¥è¨˜å¯†ç¢¼'); setPrivPwdInput('');
      };

      const TabButton = ({ tab, label }) => (
        <button
          onClick={() => setActiveTab(tab)}
          className={`px-4 py-2 font-medium rounded-lg transition ${
            activeTab === tab
              ? 'primary-bg text-white shadow-md'
              : 'text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700'
          }`}
        >
          {label}
        </button>
      );

      return (
        <div className="fixed inset-0 bg-black/40 flex items-end sm:items-center justify-center z-50">
          <div className="bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div className="p-4 border-b flex items-center justify-between">
              <div className="font-bold text-lg">è¨­å®šé¢æ¿</div>
              <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="x"/></button>
            </div>

            <div className="p-4 border-b flex gap-3">
              <TabButton tab="personal" label="å€‹äºº"/>
              <TabButton tab="general" label="é€šç”¨"/>
            </div>

            <div className="p-4 space-y-8">
              {activeTab === 'personal' && (
                <div className="space-y-8">
                  <section>
                    <h3 className="font-semibold mb-2">ä»˜è²»æœƒå“¡</h3>
                    <div className="text-sm text-gray-600 mb-2">
                      ç›®å‰èº«åˆ†ï¼š<span className="font-semibold">{profile?.role || 'user'}</span> |
                      æœƒå“¡ç­‰ç´šï¼š<span className="font-semibold">{membership?.tier || 'free'}</span>ï¼ˆåˆ°æœŸï¼š{membershipExpireText}ï¼‰
                    </div>
                    <div className="flex flex-wrap items-center gap-2">
                      <button onClick={()=>onSetMembershipTier('free')} className="px-2 py-1 rounded border">Free</button>
                      <button onClick={()=>onSetMembershipTier('pro')}  className="px-2 py-1 rounded border">Proï¼ˆç¤ºç¯„ï¼‰</button>
                      <button onClick={()=>onSetMembershipTier('vip')}  className="px-2 py-1 rounded border">VIPï¼ˆç¤ºç¯„ï¼‰</button>
                    </div>
                    <div className="mt-3 grid sm:grid-cols-2 gap-2">
                      <input value={couponCode} onChange={e=>setCouponCode(e.target.value)} className="border rounded-lg p-2" placeholder="è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼"/>
                      <button onClick={()=>onApplyCoupon(couponCode)} className="px-3 py-2 rounded-lg border hover:bg-gray-50">å¥—ç”¨å„ªæƒ åˆ¸</button>
                    </div>
                    {isAdmin && (
                      <div className="mt-4 border-t pt-4">
                        <div className="text-sm text-gray-600 mb-2">ï¼ˆç®¡ç†å“¡ï¼‰å»ºç«‹å„ªæƒ åˆ¸</div>
                        <div className="grid sm:grid-cols-4 gap-2">
                          <input value={newCoupon.code} onChange={e=>setNewCoupon({...newCoupon, code:e.target.value})} className="border rounded-lg p-2" placeholder="ä»£ç¢¼ï¼Œå¦‚ OFF200"/>
                          <input type="number" min="0" value={newCoupon.discountAmount} onChange={e=>setNewCoupon({...newCoupon, discountAmount: parseInt(e.target.value||'0')})} className="border rounded-lg p-2" placeholder="æŠ˜æŠµé‡‘é¡ï¼ˆNT$ï¼‰"/>
                          <input type="number" min="1" value={newCoupon.months} onChange={e=>setNewCoupon({...newCoupon, months:parseInt(e.target.value||'1')})} className="border rounded-lg p-2" placeholder="å»¶é•·æœˆæ•¸ï¼ˆå¯ç•™ç©ºï¼‰"/>
                          <select value={String(newCoupon.active)} onChange={e=>setNewCoupon({...newCoupon, active:(e.target.value==='true')})} className="border rounded-lg p-2">
                            <option value="true">å•Ÿç”¨</option>
                            <option value="false">åœç”¨</option>
                          </select>
                        </div>
                        <button onClick={()=>onCreateCoupon(newCoupon)} className="mt-2 px-3 py-2 rounded-lg border hover:bg-gray-50">å»ºç«‹ / æ›´æ–°</button>
                        <div className="text-xs text-gray-500 mt-1">
                          æ¬„ä½ï¼šcodeã€discountAmountï¼ˆå„ªå…ˆå¥—ç”¨ï¼‰ã€monthsï¼ˆå¯é¸ï¼‰ã€active<br/>
                          è·¯å¾‘ï¼šFirestore /coupons/{'{code}'}
                        </div>
                      </div>
                    )}
                  </section>
                  <section>
                    <h3 className="font-semibold mb-2">ç§å¯†æ—¥è¨˜å¯†ç¢¼</h3>
                    <p className="text-sm text-gray-500 mb-2">è¨­å®šå¾Œï¼Œé–‹å•Ÿ <span class="font-semibold">ç§å¯†æ—¥è¨˜</span> æœƒå…ˆè¦æ±‚è¼¸å…¥å¯†ç¢¼ã€‚</p>
                    <div className="flex items-center gap-2">
                      <input
                        type={privPwdVisible ? 'text' : 'password'}
                        value={privPwdInput}
                        onChange={e=>setPrivPwdInput(e.target.value)}
                        className="flex-1 border rounded-lg p-2"
                        placeholder="è¼¸å…¥æ–°å¯†ç¢¼"
                      />
                      <button onClick={()=>setPrivPwdVisible(v=>!v)} className="px-3 py-2 rounded-lg border hover:bg-gray-50">
                        {privPwdVisible?'éš±è—':'é¡¯ç¤º'}
                      </button>
                    </div>
                    <div className="flex items-center gap-2 mt-2">
                      <button onClick={async()=>{
                        if(!privPwdInput){ alert('è«‹å…ˆè¼¸å…¥å¯†ç¢¼'); return; }
                        const hashed = await sha256Hex(privPwdInput);
                        if(user){
                          await db.collection('users').doc(user.uid).set({ privatePasswordHash: hashed }, { merge:true });
                        }else{
                          localStorage.setItem('privatePasswordHash', hashed);
                        }
                        alert('ç§å¯†æ—¥è¨˜å¯†ç¢¼å·²è¨­å®š âœ…'); setPrivPwdInput('');
                      }} className="px-3 py-2 rounded-lg primary-bg text-white">è¨­å®šå¯†ç¢¼</button>
                      <button onClick={async()=>{
                        if(user){
                          await db.collection('users').doc(user.uid).set({ privatePasswordHash: firebase.firestore.FieldValue.delete() }, { merge:true });
                        }else{
                          localStorage.removeItem('privatePasswordHash');
                        }
                        alert('å·²æ¸…é™¤ç§å¯†æ—¥è¨˜å¯†ç¢¼'); setPrivPwdInput('');
                      }} className="px-3 py-2 rounded-lg border hover:bg-gray-50">æ¸…é™¤å¯†ç¢¼</button>
                    </div>
                    <div className="text-xs text-gray-500 mt-2">
                      ç›®å‰ç‹€æ…‹ï¼š{currentHashed ? <span class="text-green-600">å·²è¨­å®š</span> : <span class="text-red-600">å°šæœªè¨­å®š</span>}
                    </div>
                  </section>
                </div>
              )}
              
              {activeTab === 'general' && (
                <div className="space-y-8">
                  <section>
                    <h3 className="font-semibold mb-2">å¤–è§€</h3>
                    <div className="flex items-center gap-3 mb-3">
                      <label className="text-sm text-gray-500">ä¸»é¡Œè‰²</label>
                      <input type="color" value={themeColor} onChange={e=>setThemeColor(e.target.value)} />
                      <button onClick={()=>setThemeColor('#7c3aed')} className="px-2 py-1 rounded bg-gray-100">é è¨­ç´«</button>
                      <button onClick={()=>setThemeColor('#0ea5e9')} className="px-2 py-1 rounded bg-gray-100">è—</button>
                      <button onClick={()=>setThemeColor('#f97316')} className="px-2 py-1 rounded bg-gray-100">æ©˜</button>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className="text-sm text-gray-500">æ·±è‰²æ¨¡å¼</span>
                      <label className="switch">
                        <input type="checkbox" checked={darkMode} onChange={e=>setDarkMode(e.target.checked)}/>
                        <span className="slider"></span>
                      </label>
                    </div>
                  </section>
                  <section>
                    <h3 className="font-semibold mb-2">è³‡æ–™åŒ¯å…¥ / åŒ¯å‡º</h3>
                    <div className="flex flex-wrap items-center gap-3">
                      <button onClick={exportDiaries} className="px-3 py-2 rounded-lg border hover:bg-gray-50 flex items-center gap-2">
                        <Icon name="download"/><span>åŒ¯å‡º JSON</span>
                      </button>
                      <label className="px-3 py-2 rounded-lg border hover:bg-gray-50 cursor-pointer flex items-center gap-2">
                        <Icon name="import"/><span>åŒ¯å…¥ JSON</span>
                        <input type="file" accept="application/json" className="hidden" onChange={e=>e.target.files[0]&&importDiaries(e.target.files[0])}/>
                      </label>
                      <button onClick={onBackupToStorage} className="px-3 py-2 rounded-lg border hover:bg-gray-50">å‚™ä»½åˆ° Firebase Storage</button>
                      <button onClick={onRestoreFromStorage} className="px-3 py-2 rounded-lg border hover:bg-gray-50">å¾ Storage é‚„åŸ</button>
                    </div>
                  </section>
                  <section>
                    <h3 className="font-semibold mb-2">æé†’</h3>
                    <div className="grid sm:grid-cols-2 gap-3 items-end">
                      <input value={title} onChange={e=>setTitle(e.target.value)} className="border rounded-lg p-2" placeholder="æé†’å…§å®¹ï¼Œå¦‚ï¼šæ™šä¸Š 9 é»å¯«æ—¥è¨˜"/>
                      <div className="flex items-center gap-2">
                        <input type="datetime-local" value={when} onChange={e=>setWhen(e.target.value)} className="border rounded-lg p-2"/>
                        <select value={freq} onChange={e=>setFreq(e.target.value)} className="border rounded-lg p-2">
                          <option value="ONCE">ä¸€æ¬¡</option>
                          <option value="DAILY">æ¯å¤©</option>
                          <option value="WEEKLY">æ¯é€±</option>
                        </select>
                      </div>
                      <button onClick={()=>{
                        if(!when){alert('è«‹é¸æ“‡æ™‚é–“');return;}
                        onAddReminder({title, when, freq}); setTitle(''); setWhen(''); setFreq('ONCE');
                      }} className="sm:col-span-2 w-full primary-bg text-white rounded-lg py-2">æ–°å¢æé†’</button>
                    </div>
                    <div className="mt-3">
                      <div className="text-sm text-gray-500 mb-1">ç›®å‰æé†’</div>
                      {reminders.length===0 ? <div className="text-gray-400 text-sm">å°šç„¡æé†’</div> :
                        <div className="space-y-2">
                          {reminders.map(r=>{
                            const dt = toDate(r.at); const txt = dt ? dt.toLocaleString('zh-TW') : 'â€”';
                            return (
                              <div key={r.id} className="flex items-center justify-between border rounded-lg p-2">
                                <div>
                                  <div className="font-medium">{r.title||'(ç„¡æ¨™é¡Œ)'}</div>
                                  <div className="text-xs text-gray-500">{txt} Â· {r.freq||'ONCE'}</div>
                                </div>
                                <button onClick={()=>onRemoveReminder(r.id)} className="px-2 py-1 rounded bg-red-50 text-red-600">åˆªé™¤</button>
                              </div>
                            );
                          })}
                        </div>
                      }
                      <button onClick={()=>ReminderService.requestPermission()} className="mt-3 px-3 py-2 rounded-lg border hover:bg-gray-50 flex items-center gap-2">
                        <Icon name="bell"/><span>å…è¨±æ¡Œé¢é€šçŸ¥</span>
                      </button>
                    </div>
                  </section>
                  <section>
                    <h3 className="font-semibold mb-2">å¯¦ç”¨å·¥å…·</h3>
                    <div className="flex flex-wrap gap-2">
                      <button onClick={todayShortcut} className="px-3 py-2 rounded-lg border hover:bg-gray-50">è·³åˆ°ä»Šå¤©</button>
                      <button onClick={toggleFavoritesOnly} className={`px-3 py-2 rounded-lg border hover:bg-gray-50 ${favoritesOnly?'bg-yellow-50':''}`}>åªçœ‹æœ€æ„›ï¼š{favoritesOnly?'ON':'OFF'}</button>
                    </div>
                    <div className="text-xs text-gray-500 mt-2">å‚™è¨»ï¼šé‡‘æµä»ç‚ºç¤ºç¯„ï¼Œæœªä¸²ç¬¬ä¸‰æ–¹æ”¯ä»˜ã€‚</div>
                  </section>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    /* å´é‚Šæ¬„å…ƒä»¶ (SidebarContent) [åŸå°ä¸å‹•é™¤äº†æœ‰ map é …ç›®] */
    const SidebarContent = ({ darkMode, user, activeView, setActiveView, setSidebarOpen }) => {
      const dark = darkMode;

      const NavItem = ({ icon, text, viewName, badge = null }) => {
        const active = activeView === viewName;
        return (
          <button 
            onClick={() => {
              setActiveView(viewName);
              setSidebarOpen(false);
            }}
            className={`
              flex items-center gap-4 w-full text-left px-5 py-3 rounded-lg transition
              ${active
                ? 'bg-blue-600 text-white shadow'
                : `
                  ${dark
                    ? 'text-gray-300 hover:bg-gray-700'
                    : 'text-gray-700 hover:bg-gray-100'}
                `}
            `}
          >
            <Icon name={icon} className="w-5 h-5 flex-shrink-0" />
            <span className="font-medium flex-1 truncate">{text}</span>
            {badge && (
              <span className={`text-xs ${active ? 'text-white' : 'text-blue-500'}`}>
                {badge}
              </span>
            )}
          </button>
        );
      };

      const LabelHeader = ({ title }) => (
         <div className={`
           px-5 py-2 mt-2
           ${dark ? 'text-gray-500' : 'text-gray-600'}
         `}>
           <span className="text-sm">{title}</span>
         </div>
      );

      return (
        <div className={`
          flex flex-col h-full w-full
          ${dark ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900 border-r border-gray-200'}
        `}>
          
          <div className={`flex items-center gap-3 p-4 ${dark ? 'border-b border-gray-700' : 'border-b'}`}>
            {user ? (
              <>
                <div className="w-10 h-10 rounded-lg bg-blue-500 flex items-center justify-center text-white font-bold text-lg">
                  {(user.displayName || user.email || 'U').charAt(0).toUpperCase()}
                </div>
                <span className="font-semibold text-lg truncate" title={user.displayName || user.email}>
                  {user.displayName || user.email}
                </span>
              </>
            ) : (
              <>
                <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${dark ? 'bg-gray-700' : 'bg-gray-200'}`}>
                  <Icon name="user" className={`w-6 h-6 ${dark ? 'text-gray-400' : 'text-gray-500'}`} />
                </div>
                <span className="font-semibold text-lg text-gray-500">
                  æœªç™»å…¥
                </span>
              </>
            )}
          </div>

          <div className="flex-1 overflow-y-auto p-3 space-y-1">
            <NavItem icon="archive" text="æ‰€æœ‰è¨˜éŒ„" viewName="list" />
            <NavItem icon="calendar" text="æ—¥æ›†" viewName="calendar" />
            <NavItem icon="chart" text="åˆ†æ" viewName="analysis" />
            <NavItem icon="map-pin" text="åœ°åœ–" viewName="map" />

            <LabelHeader title="æ™‚é–“" />
            <NavItem icon="sun" text="æ—©ä¸Š" viewName="morning" />
            <NavItem icon="sun" text="ä¸‹åˆ" viewName="afternoon" />
            <NavItem icon="moon" text="æ™šä¸Š" viewName="night" badge="â— ç¾åœ¨" />

            <LabelHeader title="å€åŸŸ" />
            <NavItem icon="plus" text="æ–°å€åŸŸ" viewName="newArea" />

            <LabelHeader title="åƒè€ƒ" />
            <NavItem icon="refresh-ccw" text="ç¿’æ…£" viewName="habits" />
            <NavItem icon="scissors" text="ä¼‘å‡æ¨¡å¼" viewName="vacation" />
            <NavItem icon="star" text="ä»˜æ¬¾" viewName="premium" />
            <NavItem icon="gear" text="æ‡‰ç”¨è¨­ç½®" viewName="settings" />
          </div>
        </div>
      );
    };

    /* [âœ… æ–°å¢] åœ°é»é¸æ“‡å…ƒä»¶ï¼šç¸£å¸‚ + Google Places è‡ªå‹•å®Œæˆ */
    const LocationPicker = ({ value, county, onChange, darkMode }) => {
      const inputRef = React.useRef(null);

      React.useEffect(() => {
        let destroyed = false;

        waitForGoogleMaps().then(() => {
          if (destroyed || !inputRef.current) return;
          const ac = new window.google.maps.places.Autocomplete(inputRef.current, {
            fields: ['place_id', 'name', 'geometry', 'formatted_address'],
            componentRestrictions: { country: 'tw' }
          });
          ac.addListener('place_changed', () => {
            const place = ac.getPlace();
            const name = place?.name || inputRef.current.value || '';
            const address = place?.formatted_address || '';
            const lat = place?.geometry?.location?.lat?.();
            const lng = place?.geometry?.location?.lng?.();

            const countyText = county || '';
            const locationText = countyText
              ? `${countyText} Â· ${name || ''}`.trim()
              : (name || '');

            onChange({
              county: countyText,
              placeText: name || address,
              location: locationText,
              placeId: place?.place_id || '',
              lat: (typeof lat === 'number' ? lat : null),
              lng: (typeof lng === 'number' ? lng : null),
            });
          });
        }).catch(() => {
          // å¦‚æœ Google æ²’è¼‰åˆ°ï¼Œå°±ç•¶ä¸€èˆ¬è¼¸å…¥æ¡†ç”¨ï¼Œä¸å ±éŒ¯
        });

        return () => { destroyed = true; };
      }, [county, onChange]);

      return (
        <div className="grid grid-cols-1 md:grid-cols-[160px_1fr] gap-2">
          {/* ç¸£å¸‚ä¸‹æ‹‰ */}
          <select
            value={county || ''}
            onChange={e=>{
              const nextCounty = e.target.value;
              onChange({
                county: nextCounty,
                placeText: value || '',
                location: nextCounty
                  ? `${nextCounty} Â· ${value||''}`.trim()
                  : (value||'')
              });
            }}
            className={`border rounded-lg p-2 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
          >
            <option value="">ï¼ˆé¸æ“‡ç¸£å¸‚ï¼‰</option>
            {TAIWAN_COUNTIES.map(c => <option key={c} value={c}>{c}</option>)}
          </select>

          {/* Google Places è‡ªå‹•å®Œæˆè¼¸å…¥æ¡† */}
          <input
            ref={inputRef}
            placeholder="æ‚¨åœ¨å“ªè£¡ï¼Ÿï¼ˆå¯è¼¸å…¥åœ°æ¨™ã€åœ°å€ã€åº—åâ€¦ï¼‰"
            defaultValue={value || ''}
            onChange={(e)=>{
              const text = e.target.value;
              onChange({
                county: county || '',
                placeText: text,
                location: county ? `${county} Â· ${text}` : text
              });
            }}
            className={`w-full border rounded-lg p-2 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
          />
        </div>
      );
    };

    /* ä¸» App */
    const DiaryApp = () => {
      const [user, setUser] = useState(null);
      const [diaries, setDiaries] = useState([]);
      const [filteredDiaries, setFilteredDiaries] = useState([]);
      const [currentDiary, setCurrentDiary] = useState(null);
      const [showNewDiary, setShowNewDiary] = useState(false);
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedTag, setSelectedTag] = useState('');
      const [sortBy, setSortBy] = useState('date-desc');
      const [filterMood, setFilterMood] = useState('');
      const [darkMode, setDarkMode] = useState(localStorage.getItem('darkMode')==='1');
      const [themeColor, setThemeColor] = useState(localStorage.getItem('themeColor')||'#7c3aed');
      const [dateFilter, setDateFilter] = useState('');
      const [uploading, setUploading] = useState(false);
      const [settingsOpen, setSettingsOpen] = useState(false);
      const [showPremium, setShowPremium] = useState(false);
      const [appliedCoupon, setAppliedCoupon] = useState(null);
      const [selectedPlan, setSelectedPlan] = useState('monthly');
      const [profile, setProfile]     = useState(null);
      const isAdmin = profile?.role === 'admin';
      const membership = profile?.membership || { tier:'free', expiresAt:null };
      const [favoritesOnly, setFavoritesOnly] = useState(false);
      
      // [âœ… ä¿®æ”¹] formDataï¼šåŠ å…¥åœ°é»çš„çµæ§‹åŒ–æ¬„ä½
      const [formData, setFormData] = useState({
        title:'', content:'', tags:[], mood:'ğŸ˜Š', weather:'â˜€ï¸',
        isPrivate:false, isFavorite:false, images:[], newImages: [], remindAt:'',
        createdAt: new Date().toISOString(),
        location: '',
        locationCounty:'',
        locationPlace:'',
        locationPlaceId:'',
        locationLat: null,
        locationLng: null,
      });

      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [activeView, setActiveView] = useState('list');

      useEffect(()=>{ ReminderService.requestPermission(); ReminderService.scheduleTicker(); },[]);
      useEffect(()=>{ document.documentElement.style.setProperty('--primary', themeColor); localStorage.setItem('themeColor', themeColor); },[themeColor]);
      useEffect(()=>{ localStorage.setItem('darkMode', darkMode ? '1' : '0'); }, [darkMode]);
      
      // Auth + Firestore
      useEffect(()=>{
        const unsub = auth.onAuthStateChanged(async (u)=>{
          setUser(u||null);
          if(u){
            db.collection('users').doc(u.uid).onSnapshot(s=>{
              if(s.exists){
                const d = s.data();
                setProfile({ role: d.role||'user', membership: d.membership||{tier:'free',expiresAt:null}, privatePasswordHash: d.privatePasswordHash });
              }else{
                if (u.displayName) {
                   db.collection('users').doc(u.uid).set({ 
                      role: 'user', 
                      membership: { tier: 'free', expiresAt: null }
                   }, { merge: true });
                } else {
                   setProfile({ role:'user', membership:{ tier:'free', expiresAt:null }, privatePasswordHash: undefined });
                }
              }
            });
            db.collection('users').doc(u.uid).collection('diaries')
              .orderBy('createdAt','desc')
              .onSnapshot(snap=>{
                const arr = [];
                snap.forEach(doc=>arr.push({ id:doc.id, ...doc.data() }));
                setDiaries(arr);
              }, err=>alert('è®€å–æ—¥è¨˜å¤±æ•—ï¼š'+err.message));
          }else{
            const sample = [
              { id:'1', title:'ç¾å¥½çš„ä¸€å¤©', content:'ä»Šå¤©å¤©æ°£å¾ˆå¥½ï¼Œå»å…¬åœ’æ•£æ­¥...', tags:['ç”Ÿæ´»','å¥åº·'], mood:'ğŸ˜Š', weather:'â˜€ï¸', isPrivate:false, isFavorite:true, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString(), images:[], location:'è‡ºåŒ—å¸‚ Â· å…¬åœ’' },
              { id:'2', title:'å·¥ä½œä¸Šçš„æŒ‘æˆ°', content:'ä»Šå¤©é‡åˆ°äº†ä¸€å€‹é›£é¡Œ...', tags:['å·¥ä½œ','å­¸ç¿’'], mood:'ğŸ¤”', weather:'â˜ï¸', isPrivate:false, isFavorite:false, createdAt:new Date(Date.now()-86400000).toISOString(), updatedAt:new Date(Date.now()-86400000).toISOString(), images:[], location:'' },
              { id:'3', title:'é€±æœ«è¨ˆç•«', content:'é€™å€‹é€±æœ«æƒ³å»çˆ¬å±±...', tags:['ç”Ÿæ´»','èˆˆè¶£'], mood:'ğŸ˜', weather:'ğŸŒˆ', isPrivate:false, isFavorite:false, createdAt:new Date(Date.now()-86400000*2).toISOString(), updatedAt:new Date(Date.now()-86400000*2).toISOString(), images:[], location:'æ–°åŒ—å¸‚ Â· çˆ¬å±±æ­¥é“' }
            ];
            setProfile(null); setDiaries(sample);
          }
        });
        return ()=>unsub();
      },[]);

      // éæ¿¾æ’åº (åŸå°ä¸å‹•)
      useEffect(()=>{
        let filtered = [...diaries];
        if (searchTerm) {
          filtered = filtered.filter(d =>
            (d.title||'').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (d.content||'').toLowerCase().includes(searchTerm.toLowerCase())
          );
        }
        if (selectedTag) filtered = filtered.filter(d => (d.tags||[]).includes(selectedTag));
        if (filterMood) filtered = filtered.filter(d => d.mood === filterMood);
        if (dateFilter) {
          filtered = filtered.filter(d => {
            const dt = toDate(d.createdAt);
            return dt ? localDateKey(dt) === dateFilter : false;
          });
        }
        if (favoritesOnly) filtered = filtered.filter(d => d.isFavorite);
        filtered.sort((a,b)=>{
          const da = toDate(a.createdAt);
          const dbb = toDate(b.createdAt);
          const ta = da ? da.getTime() : 0;
          const tb = dbb ? dbb.getTime() : 0;
          switch (sortBy) {
            case 'date-desc': return tb - ta;
            case 'date-asc' : return ta - tb;
            case 'title'    : return (a.title||'').localeCompare(b.title||'');
            default: return 0;
          }
        });
        setFilteredDiaries(filtered);
      },[diaries, searchTerm, selectedTag, filterMood, sortBy, dateFilter, favoritesOnly]);

      // ä¸Šå‚³åœ–ç‰‡ (åŸå°ä¸å‹•çš„è¡Œç‚º)
      const onUploadImages = async (files)=>{
        if(!files || files.length===0) return [];
        const urls = [];
        for(const f of files){
          if(!user){
            urls.push(URL.createObjectURL(f));
          }else{
            const url = await uploadFileToStorage(f, user.uid);
            urls.push(url);
          }
        }
        return urls;
      };

      // å„²å­˜/åˆªé™¤/ç·¨è¼¯æ—¥è¨˜
      const handleSaveDiary = async ()=>{
        if(!formData.title || !formData.content){ alert('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹'); return; }
        
        setUploading(true);
        
        try {
          let uploadedImageUrls = [];
          if (formData.newImages && formData.newImages.length > 0) {
              uploadedImageUrls = await onUploadImages(formData.newImages); 
          }
          
          const finalImages = [...(formData.images || []), ...uploadedImageUrls];
          
          const docData = {
            title: formData.title,
            content: formData.content,
            tags: formData.tags||[],
            mood: formData.mood||'ğŸ˜Š',
            weather: formData.weather||'â˜€ï¸',
            isPrivate: !!formData.isPrivate,
            isFavorite: !!formData.isFavorite,
            images: finalImages,
            createdAt: formData.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString(),

            // [âœ… æ–°å¢] åœ°é»è³‡è¨Šå®Œæ•´å¯«å…¥
            location: formData.location || '',
            locationCounty: formData.locationCounty || '',
            locationPlace: formData.locationPlace || '',
            locationPlaceId: formData.locationPlaceId || '',
            locationLat: (formData.locationLat ?? null),
            locationLng: (formData.locationLng ?? null),
          };

          if(formData.remindAt){
            const when = new Date(formData.remindAt);
            if (!isNaN(when.getTime())) {
              ReminderService.add({
                id: (currentDiary?.id)||docData.createdAt,
                at: when.toISOString(), title: docData.title, freq: 'ONCE', fired:false
              });
              alert('æé†’å·²è¨­å®šï¼š'+when.toLocaleString('zh-TW'));
            } else { alert('æé†’æ™‚é–“æ ¼å¼ä¸æ­£ç¢ºï¼Œå·²å¿½ç•¥ã€‚'); }
          }

          if(user){
            const col = db.collection('users').doc(user.uid).collection('diaries');
            if(currentDiary){ await col.doc(currentDiary.id).set(docData, { merge:true }); }
            else { await col.add(docData); }
          }else{
            const id = currentDiary?.id || Date.now().toString();
            const newItem = { id, ...docData };
            if(currentDiary){ setDiaries(diaries.map(d=>d.id===id?newItem:d)); }
            else{ setDiaries([newItem, ...diaries]); }
          }
          
          resetForm();

        } catch (e) {
          alert('å„²å­˜å¤±æ•—ï¼š'+e.message);
        } finally {
          setUploading(false);
        }
      };

      const handleDeleteDiary = async (id)=>{
        if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ—¥è¨˜å—ï¼Ÿ')) return;
        if(user){ await db.collection('users').doc(user.uid).collection('diaries').doc(id).delete(); }
        else{ setDiaries(diaries.filter(d=>d.id!==id)); }
        if(currentDiary?.id===id) setCurrentDiary(null);
      };

      const handleEditDiary = (diary)=>{
        setCurrentDiary(diary);
        setFormData({ 
          ...diary, 
          remindAt:'',
          createdAt: diary.createdAt || new Date().toISOString(),
          // [âœ… æ–°å¢] ç·¨è¼¯æ™‚å¸¶å›åœ°é»è³‡æ–™
          location: diary.location || '',
          locationCounty: diary.locationCounty || '',
          locationPlace: diary.locationPlace || '',
          locationPlaceId: diary.locationPlaceId || '',
          locationLat: diary.locationLat ?? null,
          locationLng: diary.locationLng ?? null,
          newImages: []
        });
        setShowNewDiary(true);
        setActiveView('list');
      };

      const toggleFavorite = async (id)=>{
        if(user){
          const doc = diaries.find(d=>d.id===id);
          await db.collection('users').doc(user.uid).collection('diaries').doc(id)
            .set({ isFavorite: !doc.isFavorite, updatedAt:new Date().toISOString() }, { merge:true });
        }else{
          setDiaries(diaries.map(d=>d.id===id?{...d,isFavorite:!d.isFavorite}:d));
        }
      };

      const resetForm = ()=>{
        setFormData({ 
          title:'',content:'',tags:[],mood:'ğŸ˜Š',weather:'â˜€ï¸',
          isPrivate:false,isFavorite:false,images:[], remindAt:'',
          createdAt: new Date().toISOString(),
          newImages: [],
          // [âœ… æ–°å¢] æ¸…ç©ºåœ°é»è³‡æ–™
          location: '',
          locationCounty:'',
          locationPlace:'',
          locationPlaceId:'',
          locationLat: null,
          locationLng: null,
        });
        setCurrentDiary(null);
        setShowNewDiary(false);
      };

      const handleTagToggle = (tag)=>{
        setFormData(prev=>({
          ...prev,
          tags: (prev.tags || []).includes(tag) ? prev.tags.filter(t=>t!==tag) : [...prev.tags, tag]
        }));
      };

      // åŒ¯å…¥åŒ¯å‡º
      const exportDiaries = ()=>{
        const dataStr = JSON.stringify(diaries, null, 2);
        const blob = new Blob([dataStr],{ type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href=url; a.download=`diary_backup_${localDateKey(new Date())}.json`; a.click();
      };

      const importDiaries = async (file)=>{
        try{
          const text = await file.text();
          const arr = JSON.parse(text);
          if(!Array.isArray(arr)) throw new Error('JSON æ ¼å¼ä¸æ­£ç¢ºï¼ˆéœ€è¦é™£åˆ—ï¼‰');
          if(user){
            const batch = db.batch();
            const col = db.collection('users').doc(user.uid).collection('diaries');
            arr.forEach(d=>{
              const ref = d.id ? col.doc(d.id) : col.doc();
              batch.set(ref, {
                title:d.title||'',
                content:d.content||'',
                tags:d.tags||[],
                mood:d.mood||'ğŸ˜Š',
                weather:d.weather||'â˜€ï¸',
                isPrivate:!!d.isPrivate,
                isFavorite:!!d.isFavorite,
                images:d.images||[],
                createdAt:d.createdAt||new Date().toISOString(),
                updatedAt:new Date().toISOString(),
                // [âœ… ä¿®æ”¹] åŒ¯å…¥æ™‚ä¿ç•™åœ°é»è³‡è¨Š
                location: d.location || '',
                locationCounty: d.locationCounty || '',
                locationPlace: d.locationPlace || '',
                locationPlaceId: d.locationPlaceId || '',
                locationLat: (d.locationLat ?? null),
                locationLng: (d.locationLng ?? null),
              }, { merge:true });
            });
            await batch.commit(); alert('å·²åŒ¯å…¥è‡³é›²ç«¯');
          }else{
            const map = Object.fromEntries(diaries.map(d=>[d.id,d]));
            arr.forEach(d=>{
              const id=d.id||(Date.now()+Math.random()).toString();
              map[id]={ id, ...d };
            });
            setDiaries(Object.values(map).sort((a,b)=>{
              const da=toDate(a.createdAt), dbb=toDate(b.createdAt);
              return (dbb?dbb.getTime():0)-(da?da.getTime():0);
            }));
            alert('å·²åŒ¯å…¥ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰');
          }
        }catch(e){ alert('åŒ¯å…¥å¤±æ•—ï¼š'+e.message); }
      };

      // æé†’ (åŸå°ä¸å‹•)
      const reminders = useMemo(()=>ReminderService.load(), [settingsOpen]);
      const onAddReminder = ({title, when, freq})=>{
        const id = `rem_${Date.now()}`;
        const dt = new Date(when);
        if (isNaN(dt.getTime())) { alert('æ™‚é–“æ ¼å¼ä¸æ­£ç¢º'); return; }
        ReminderService.add({ id, title, at: dt.toISOString(), freq, fired:false });
        alert('å·²æ–°å¢æé†’');
      };
      const onRemoveReminder = (id)=>{ ReminderService.remove(id); alert('å·²åˆªé™¤æé†’'); };

      // æœƒå“¡/å„ªæƒ åˆ¸/ä»˜æ¬¾ (åŸå°ä¸å‹•)
      const onSetMembershipTier = async (tier)=>{
        if(!user){ alert('è«‹å…ˆç™»å…¥'); return; }
        const expiresAt = membership?.expiresAt ? toDate(membership.expiresAt) : new Date();
        if(tier==='free'){
          await db.collection('users').doc(user.uid).set({ membership:{ tier:'free', expiresAt:null }}, {merge:true});
        }else{
          const base = expiresAt || new Date();
          base.setDate(base.getDate()+30);
          await db.collection('users').doc(user.uid).set({ membership:{ tier, expiresAt: base.toISOString() }},{merge:true});
        }
        alert('æœƒå“¡ç‹€æ…‹å·²æ›´æ–°ï¼ˆç¤ºç¯„ï¼‰');
      };
      const onCreateCoupon = async ({code, months, active, discountAmount})=>{
        if(!user || !isAdmin){ alert('éœ€è¦ç®¡ç†å“¡æ¬Šé™'); return; }
        if(!code){ alert('è«‹è¼¸å…¥ä»£ç¢¼'); return; }
        const payload = {
          code,
          active: !!active,
          discountAmount: Math.max(0, parseInt(discountAmount||0)),
          discountMonths: Math.max(0, parseInt(months||0)) || null,
          createdBy: user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('coupons').doc(code).set(payload, { merge:true });
        alert('å·²å»ºç«‹/æ›´æ–°å„ªæƒ åˆ¸ï¼š'+code);
      };
      const onApplyCoupon = async (code)=>{
        if(!user){ 
          alert('è«‹å…ˆç™»å…¥æ‰èƒ½å¥—ç”¨å„ªæƒ åˆ¸'); 
          return; 
        }
        if(!code){ 
          alert('è«‹è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼'); 
          return; 
        }
        try{
          const snap = await db.collection('coupons').doc(code).get();
          if(!snap.exists){ 
            alert('å„ªæƒ åˆ¸ä¸å­˜åœ¨'); 
            return; 
          }
          const c = snap.data();
          if(c.active === false){ 
            alert('æ­¤å„ªæƒ åˆ¸æœªå•Ÿç”¨'); 
            return; 
          }
          const discountAmount = Math.max(0, Number(c.discountAmount||0));
          if(discountAmount <= 0){ 
            alert('æ­¤å„ªæƒ åˆ¸æœªè¨­å®šæŠ˜æŠµé‡‘é¡'); 
            return; 
          }
          setAppliedCoupon({ code, discountAmount, active:true });
          alert(`å·²å¥—ç”¨å„ªæƒ åˆ¸ï¼š${code}ï¼ˆå¯æŠ˜æŠµ NT$ ${discountAmount}ï¼‰`);
        }catch(err){
          alert('è®€å–å„ªæƒ åˆ¸å¤±æ•—ï¼š' + err.message);
        }
      };
      const onClearCoupon = ()=> setAppliedCoupon(null);
      const onPurchase = async (plan, coupon, basePrice, duePrice)=> {
        if(!user){ alert('è«‹å…ˆç™»å…¥'); return; }
        const now = new Date();
        let base = membership?.expiresAt ? toDate(membership.expiresAt) : now;
        if(!base || base < now) base = now;
        if(plan==='monthly'){ base.setMonth(base.getMonth()+1); }
        if(plan==='yearly'){ base.setFullYear(base.getFullYear()+1); }
        await db.collection('users').doc(user.uid).set({
          membership:{ tier:'pro', expiresAt: base.toISOString() }
        }, { merge:true });
        if(coupon?.code){
          const usedId = `${user.uid}_${coupon.code}`;
          await db.collection('coupon_redemptions').doc(usedId).set({
            uid:user.uid, code:coupon.code,
            discountAmount: Number(coupon.discountAmount||0),
            plan, basePrice, paid: duePrice,
            redeemedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        alert(`å‡ç´šæˆåŠŸï¼å¯¦ä»˜ NT$ ${duePrice}ï¼ˆ${plan==='yearly'?'å¹´è²»':'æœˆè²»'}ï¼‰ã€‚åˆ°æœŸï¼š${base.toLocaleDateString('zh-TW')}`);
        setShowPremium(false);
      };

      // å‚™ä»½/é‚„åŸ (åŸå°ä¸å‹•)
      const onBackupToStorage = async ()=>{
        if(!user){ alert('è«‹å…ˆç™»å…¥'); return; }
        const payload = JSON.stringify(diaries, null, 2);
        const ref = storage.ref().child(`${user.uid}/backups/diaries_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`);
        await ref.put(new Blob([payload],{type:'application/json'}));
        alert('å·²å‚™ä»½åˆ° Storage');
      };
      const onRestoreFromStorage = async ()=>{
        if(!user){ alert('è«‹å…ˆç™»å…¥'); return; }
        const listRef = storage.ref().child(`${user.uid}/backups/`);
        const list = await listRef.list({ maxResults: 1 });
        if(!list.items.length){ alert('æ²’æœ‰å‚™ä»½æª”'); return; }
        const url = await list.items[0].getDownloadURL();
        const res = await fetch(url);
        const arr = await res.json();
        const batch = db.batch();
        const col = db.collection('users').doc(user.uid).collection('diaries');
        arr.forEach(d=>{
          const ref = d.id ? col.doc(d.id) : col.doc();
          batch.set(ref, d, { merge:true });
        });
        await batch.commit();
        alert('å·²å¾ Storage é‚„åŸæœ€æ–°å‚™ä»½');
      };

      // å¿«æ·éµ (åŸå°ä¸å‹•)
      const todayShortcut = ()=>{ 
        const today = localDateKey(new Date()); 
        setDateFilter(today); 
        setCurrentDiary(null); 
        setShowNewDiary(false); 
        setActiveView('list');
      };
      const toggleFavoritesOnly = ()=> setFavoritesOnly(v=>!v);

      // ä¸»å…§å®¹åˆ‡æ›
      const renderMainContent = () => {
        switch (activeView) {
          case 'list':
            return (
              <div className="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                {/* å·¦æ¬„ï¼šç¯©é¸ + æ–°å¢ + æ¸…å–® */}
                <div className={`${darkMode?'bg-gray-800':'bg-white'} rounded-2xl shadow-xl p-6 max-h-screen overflow-y-auto lg:col-span-1`}>
                  <div className="space-y-4">
                    <div className="relative">
                      <div className="absolute left-3 top-3"><Icon name="search" className="w-5 h-5 text-gray-400"/></div>
                      <input type="text" placeholder="æœå°‹æ—¥è¨˜..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}
                        className={`w-full pl-10 pr-4 py-2 rounded-lg border ${darkMode?'bg-gray-700 border-gray-600 text-white':'border-gray-300'} focus:ring-2 focus:outline-none`}/>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      <select value={sortBy} onChange={e=>setSortBy(e.target.value)} className={`px-3 py-1 rounded-full text-sm ${darkMode?'bg-gray-700 text-white':'bg-gray-100'}`}>
                        <option value="date-desc">æœ€æ–°å„ªå…ˆ</option>
                        <option value="date-asc">æœ€èˆŠå„ªå…ˆ</option>
                        <option value="title">æ¨™é¡Œæ’åº</option>
                      </select>
                      <select value={filterMood} onChange={e=>setFilterMood(e.target.value)} className={`px-3 py-1 rounded-full text-sm ${darkMode?'bg-gray-700 text-white':'bg-gray-100'}`}>
                        <option value="">æ‰€æœ‰å¿ƒæƒ…</option>
                        {moods.map(m=> <option key={m} value={m}>{m}</option>)}
                      </select>
                      <button onClick={todayShortcut} className="px-2 py-1 rounded-full text-sm border">ä»Šå¤©</button>
                      <button onClick={toggleFavoritesOnly} className={`px-2 py-1 rounded-full text-sm border ${favoritesOnly?'bg-yellow-50':''}`}>åªçœ‹æœ€æ„›</button>
                    </div>
                    {dateFilter && (
                      <div className="text-sm">
                        æ—¥æœŸç¯©é¸ï¼š<span className="font-semibold">{dateFilter}</span>
                        <button onClick={()=>setDateFilter('')} className="ml-2 px-2 py-0.5 rounded bg-gray-200 hover:bg-gray-300">æ¸…é™¤</button>
                      </div>
                    )}
                    <div>
                      <div className="text-sm mb-2 text-gray-500">æ¨™ç±¤é›²ï¼ˆé»æ“Šç¯©é¸ï¼‰</div>
                      <TagCloud diaries={diaries} activeTag={selectedTag} onToggle={(t)=> setSelectedTag(selectedTag===t?'':t) } />
                    </div>
                    <button onClick={()=>{resetForm(); setShowNewDiary(true);}}
                      className="w-full primary-bg text-white py-3 rounded-lg hover:opacity-90 flex items-center justify-center gap-2">
                      <Icon name="plus"/> æ–°å¢æ—¥è¨˜
                    </button>
                    <div className="space-y-3">
                      {filteredDiaries.length===0 ? (
                        <div className="text-center py-8 text-gray-400"><p>é‚„æ²’æœ‰æ—¥è¨˜ï¼Œå¿«ä¾†å¯«ä¸€ç¯‡å§ï¼</p></div>
                      ) : filteredDiaries.map(d=>{
                        const dt = toDate(d.createdAt);
                        const dateText = dt ? dt.toLocaleDateString('zh-TW') : 'â€”';
                        return (
                          <div key={d.id}
                            onClick={()=>{ setCurrentDiary(d); setShowNewDiary(false); setDateFilter(''); }}
                            className={`p-4 rounded-lg cursor-pointer transition ${currentDiary?.id===d.id ? 'bg-purple-100 border-2 primary-border' : darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-50 hover:bg-gray-100'}`}>
                            <div className="flex items-start justify-between mb-2">
                              <div className="flex items-center gap-2">
                                <span className="text-2xl">{d.mood}</span>
                                <span className="text-lg">{d.weather}</span>
                              </div>
                              <div className="flex items-center gap-2">
                                {d.isFavorite && <Icon name="heart" className="w-4 h-4 text-red-500" fill={true}/>}
                                {d.isPrivate && <Icon name="lock" className="w-4 h-4"/>}
                              </div>
                            </div>
                            <h3 className="font-bold mb-1">{d.title}</h3>
                            <p className="text-sm text-gray-500 mb-2">{dateText}</p>
                            {d.isPrivate ? (
                              <div className="text-xs text-gray-500 italic flex items-center gap-1">
                                <Icon name="lock" className="w-3 h-3" />
                                <span>ç§å¯†å…§å®¹å·²éš±è—</span>
                              </div>
                            ) : (
                              <p className="text-sm line-clamp-2">{d.content}</p>
                            )}
                            {(d.tags||[]).length>0 && (
                              <div className="flex gap-1 mt-2 flex-wrap">
                                {d.tags.map(t=><span key={t} className="text-xs bg-purple-200 text-purple-700 px-2 py-1 rounded">#{t}</span>)}
                              </div>
                            )}
                            {d.images?.length>0 && (
                              <div className="mt-2 flex gap-2 overflow-x-auto">
                                {d.images.slice(0,3).map((url,i)=>(
                                  <img key={i} src={url} className="w-16 h-16 object-cover rounded-lg border"/>
                                ))}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>

                {/* å³æ¬„ï¼šç·¨è¼¯/æª¢è¦– */}
                <div className="lg:col-span-2 grid grid-cols-1 gap-6">
                  <div className={`${darkMode?'bg-gray-800':'bg-white'} rounded-2xl shadow-xl p-6`}>
                    {showNewDiary ? (
                      <div className="space-y-4">
                        <div className="flex items-center justify-between mb-2">
                          <h2 className="text-2xl font-bold">{currentDiary?'ç·¨è¼¯æ—¥è¨˜':'æ–°å¢æ—¥è¨˜'}</h2>
                          <button onClick={resetForm} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="x" className="w-6 h-6"/></button>
                        </div>
                        <input type="text" placeholder="æ¨™é¡Œ" value={formData.title}
                          onChange={e=>setFormData({...formData, title:e.target.value})}
                          className={`w-full text-2xl font-bold p-3 rounded-lg border ${darkMode?'bg-gray-700 border-gray-600 text-white':'border-gray-300'} focus:ring-2 focus:outline-none`}/>
                        <div className="text-sm text-gray-500">æ¨™é¡Œå­—æ•¸ï¼š{(formData.title||'').length}</div>
                        
                        {/* æ—¥æœŸé¸æ“‡å™¨ */}
                      {/* [âœ… ä¿®æ”¹å¾Œ] åœ°é»ï¼šå·¦é‚Šç¸£å¸‚ä¸‹æ‹‰ + å³é‚Šæ‰‹å‹•è¼¸å…¥ */}
<div>
  <label className="block text-sm font-medium mb-1 text-gray-700">åœ°é»</label>
  <div className="flex gap-2">
    {/* ç¸£å¸‚ä¸‹æ‹‰ä¿ç•™ */}
    <select
      value={formData.locationCounty || ''}
      onChange={(e) => {
        const county = e.target.value;
        setFormData(prev => ({
          ...prev,
          locationCounty: county,
          // å¦‚æœä¹‹å‰æœ‰æ•´åˆçš„ locationï¼Œå°±é‡æ–°æ‹¼ä¸Šç¸£å¸‚åç¨±
          location: county ? `${county} Â· ${prev.locationPlace || ''}` : prev.locationPlace || ''
        }));
      }}
      className={`w-1/3 border rounded-lg p-2 ${
        darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'
      }`}
    >
      <option value="">é¸æ“‡ç¸£å¸‚</option>
      <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
      <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
      <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
      <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
      <option value="å°å—å¸‚">å°å—å¸‚</option>
      <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
      <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
      <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
      <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
      <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
      <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
      <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
      <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
      <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
      <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
      <option value="å±æ±ç¸£">å±æ±ç¸£</option>
      <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
      <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
      <option value="å°æ±ç¸£">å°æ±ç¸£</option>
      <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
      <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
      <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
    </select>

    {/* å³é‚Šï¼šä½¿ç”¨è€…å¯è‡ªç”±è¼¸å…¥ */}
    <input
      type="text"
      placeholder="ä¾‹å¦‚ï¼šå®¶è£¡ã€å­¸æ ¡åœ–æ›¸é¤¨ã€å°åŒ—101ã€æ±å€èª å“â€¦"
      value={formData.locationPlace || ''}
      onChange={(e) => {
        const place = e.target.value;
        setFormData(prev => ({
          ...prev,
          locationPlace: place,
          location: prev.locationCounty
            ? `${prev.locationCounty} Â· ${place}`
            : place
        }));
      }}
      className={`flex-1 border rounded-lg p-2 ${
        darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'
      }`}
    />
  </div>
</div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-2">å¿ƒæƒ…</label>
                            <div className="flex gap-2 flex-wrap">
                              {moods.map(m=>(
                                <button key={m} onClick={()=>setFormData({...formData,mood:m})}
                                  className={`text-3xl p-2 rounded-lg transition ${formData.mood===m?'bg-purple-200 scale-110':'hover:bg-gray-100'}`}>
                                  {m}
                                </button>
                              ))}
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-2">å¤©æ°£</label>
                            <div className="flex gap-2 flex-wrap">
                              {weathers.map(w=>(
                                <button key={w} onClick={()=>setFormData({...formData,weather:w})}
                                  className={`text-3xl p-2 rounded-lg transition ${formData.weather===w?'bg-purple-200 scale-110':'hover:bg-gray-100'}`}>
                                  {w}
                                </button>
                              ))}
                            </div>
                          </div>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-2">æ¨™ç±¤</label>
                          <div className="flex gap-2 flex-wrap">
                            {allTags.map(tag=>(
                              <button key={tag} type="button" onClick={()=>handleTagToggle(tag)}
                                className={`px-3 py-1 rounded-lg text-sm transition ${formData.tags.includes(tag)?'primary-bg text-white':'bg-gray-200 hover:bg-gray-300'}`}>
                                #{tag}
                              </button>
                            ))}
                          </div>
                        </div>

                        <textarea placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹å‘¢..." value={formData.content}
                          onChange={e=>setFormData({...formData, content:e.target.value})}
                          className={`w-full h-64 p-4 rounded-lg border ${darkMode?'bg-gray-700 border-gray-600 text-white':'border-gray-300'} focus:ring-2 focus:outline-none resize-none`}/>
                        <div className="text-sm text-gray-500">å…§å®¹å­—æ•¸ï¼š{(formData.content||'').length}</div>
                        
                        {/* åœ–ç‰‡ä¸Šå‚³ä»‹é¢ï¼ˆåŸå°ä¸å‹•ï¼‰ */}
                        <div className="space-y-2">
                          <label className="block text-sm font-medium">åœ–ç‰‡ä¸Šå‚³</label>
                          <div className="flex items-center gap-2">
                            <label className="px-3 py-2 rounded-lg border cursor-pointer hover:bg-gray-50 flex items-center gap-2">
                              <Icon name="image"/><span>é¸æ“‡åœ–ç‰‡</span>
                              <input type="file" accept="image/*" className="hidden" multiple
                                     onChange={e => setFormData(prev => ({...prev, newImages: Array.from(e.target.files)}))}/>
                            </label>
                            {uploading && <span className="text-sm text-gray-500">ä¸Šå‚³ä¸­...</span>}
                          </div>
                          {(formData.images?.length > 0 || formData.newImages?.length > 0) && (
                            <div className="flex gap-2 flex-wrap">
                              {formData.images?.map((url,i)=>(
                                <div key={`existing-${i}`} className="relative">
                                  <img src={url} className="w-24 h-24 object-cover rounded-lg border"/>
                                  <button type="button" onClick={() => setFormData(prev => ({...prev, images: prev.images.filter((_,idx) => idx !== i)}))}
                                    className="absolute -top-2 -right-2 bg-black/60 text-white rounded-full w-6 h-6 flex items-center justify-center">Ã—</button>
                                </div>
                              ))}
                              {formData.newImages?.map((file,i)=>(
                                <div key={`new-${i}`} className="relative">
                                  <img src={URL.createObjectURL(file)} className="w-24 h-24 object-cover rounded-lg border opacity-70"/>
                                  <button type="button" onClick={() => setFormData(prev => ({...prev, newImages: prev.newImages.filter((_,idx) => idx !== i)}))}
                                    className="absolute -top-2 -right-2 bg-black/60 text-white rounded-full w-6 h-6 flex items-center justify-center">Ã—</button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>

                        <div className="flex items-center gap-4 flex-wrap">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked={formData.isPrivate}
                                   onChange={e=>setFormData({...formData,isPrivate:e.target.checked})} className="w-5 h-5"/>
                            <Icon name="lock"/><span>ç§å¯†æ—¥è¨˜</span>
                          </label>
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked={formData.isFavorite}
                                   onChange={e=>setFormData({...formData,isFavorite:e.target.checked})} className="w-5 h-5"/>
                            <Icon name="heart"/><span>åŠ å…¥æœ€æ„›</span>
                          </label>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-2">æé†’æ™‚é–“ï¼ˆæœ¬åœ°ï¼‰</label>
                            <input type="datetime-local" value={formData.remindAt}
                              onChange={e=>setFormData({...formData, remindAt:e.target.value})}
                              className="w-full border rounded-lg p-2"/>
                            <div className="text-xs text-gray-500 mt-1">åˆ°æ™‚æœƒç™¼å‡ºæ¡Œé¢é€šçŸ¥ï¼ˆéœ€ä¿æŒç€è¦½å™¨é–‹å•Ÿæˆ–å®šæœŸæª¢æŸ¥ï¼‰ã€‚</div>
                          </div>
                        </div>

                        <button onClick={handleSaveDiary}
                          className="w-full primary-bg text-white py-3 rounded-lg hover:opacity-90 flex items-center justify-center gap-2"
                          disabled={uploading}
                        >
                          {uploading ? <Icon name="refresh-ccw" className="animate-spin w-5 h-5"/> : <Icon name="save"/>}
                          {uploading ? 'ä¸Šå‚³ä¸­...' : 'å„²å­˜æ—¥è¨˜'}
                        </button>
                      </div>
                    ) : currentDiary ? (
                      (currentDiary.isPrivate
                        ? <PrivateDiaryViewer currentDiary={currentDiary} user={user} profile={profile}
                            onEdit={handleEditDiary} onDelete={handleDeleteDiary} toggleFavorite={toggleFavorite}/>
                        : <DiaryViewer currentDiary={currentDiary} onEdit={handleEditDiary} onDelete={handleDeleteDiary} toggleFavorite={toggleFavorite}/>
                      )
                    ) : (
                      <div className="flex items-center justify-center h-full text-gray-400">
                        <div className="text-center">
                          <Icon name="archive" className="w-20 h-20 mx-auto mb-4"/>
                          <p className="text-xl">é¸æ“‡ä¸€ç¯‡æ—¥è¨˜ä¾†æŸ¥çœ‹ï¼Œæˆ–å»ºç«‹æ–°çš„æ—¥è¨˜</p>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          
          case 'calendar':
            return (
              <div className="max-w-7xl mx-auto p-4">
                <h2 className="text-3xl font-bold mb-4">ğŸ—“ï¸ æ—¥æ›†æª¢è¦–</h2>
                <CalendarView 
                  diaries={diaries} 
                  onPickDate={(date) => {
                    setDateFilter(date);
                    setActiveView('list');
                    setCurrentDiary(null);
                    setShowNewDiary(false);
                  }} 
                />
              </div>
            );
          
          case 'analysis':
            return (
              <div className="max-w-7xl mx-auto p-4">
                <h2 className="text-3xl font-bold mb-4">ğŸ“Š æ•¸æ“šåˆ†æ</h2>
                <Charts diaries={diaries} darkMode={darkMode} />
              </div>
            );
          
          case 'map':
            return (
              <div className="max-w-7xl mx-auto p-4">
                <h2 className="text-3xl font-bold mb-4">ğŸ—ºï¸ åœ°åœ–æª¢è¦–</h2>
                <div className={`${darkMode?'bg-gray-800':'bg-white'} rounded-2xl shadow-xl p-6 h-96 flex items-center justify-center`}>
                  <p className="text-gray-500">(åœ°åœ–åŠŸèƒ½é–‹ç™¼ä¸­...)</p>
                </div>
              </div>
            );

          case 'settings':
            if (!settingsOpen) { setSettingsOpen(true); }
            setActiveView('list');
            return null;
          case 'premium':
            if (!showPremium) { setShowPremium(true); }
            setActiveView('list');
            return null;
          
          default:
            return (
              <div className="max-w-7xl mx-auto p-4">
                <div className="text-center py-20 text-gray-500">
                  <p className="text-xl">ğŸ› ï¸ æ­£åœ¨é–‹ç™¼ä¸­ï¼š{activeView} æª¢è¦–</p>
                  <button onClick={() => setActiveView('list')} className="mt-4 primary-bg text-white px-4 py-2 rounded-lg">
                    å›ã€Œæ‰€æœ‰è¨˜éŒ„ã€
                  </button>
                </div>
              </div>
            );
        }
      };

      // DiaryApp render
      return (
        <div className={`
          flex h-screen overflow-hidden
          ${darkMode ? 'bg-gray-900 text-white' : 'bg-transparent'}
        `}>
          
          {/* æ¡Œé¢ç‰ˆå´é‚Šæ¬„ */}
          <div className="hidden md:block w-64 flex-shrink-0 h-full">
            <SidebarContent 
              darkMode={darkMode} 
              user={user} 
              activeView={activeView} 
              setActiveView={setActiveView}
              setSidebarOpen={setSidebarOpen}
            />
          </div>

          {/* æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„ */}
          {sidebarOpen && (
            <div className="fixed inset-0 flex z-50 md:hidden">
              <div className="w-64 h-full">
                <SidebarContent 
                  darkMode={darkMode} 
                  user={user} 
                  activeView={activeView} 
                  setActiveView={setActiveView}
                  setSidebarOpen={setSidebarOpen}
                />
              </div>
              <div
                onClick={() => setSidebarOpen(false)}
                className="flex-1 bg-black/40"
              ></div>
            </div>
          )}

          {/* ä¸»å…§å®¹å€ */}
          <main className="flex-1 w-full h-screen overflow-y-auto">

            <div className={`${darkMode?'bg-gray-800':'bg-white'} shadow-lg sticky top-0 z-40`}>
              <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between flex-wrap gap-4">
                
                <div className="flex items-center gap-3">
                  <button 
                    onClick={() => setSidebarOpen(true)}
                    className={`p-2 rounded-lg md:hidden ${darkMode ? 'text-white' : 'text-gray-700'}`}
                    title="é–‹å•Ÿé¸å–®"
                  >
                    <Icon name="menu" className="w-6 h-6" />
                  </button>

                  <button
  onClick={() => {
    setActiveView('list');
    setDateFilter('');
    setCurrentDiary(null);
    setShowNewDiary(false);
  }}
  className="flex items-center gap-2 text-2xl font-bold primary-text"
  title="å›åˆ°é¦–é "
>
  <img src="./assets/img/journal-favicon.png" alt="logo" className="w-7 h-7 rounded" />
  <span>æˆ‘çš„æ—¥è¨˜æœ¬</span>
</button>

                </div>

                <div className="flex items-center gap-3 flex-wrap">
                  <button onClick={()=>setShowPremium(true)} className="px-3 py-1 rounded-lg primary-bg text-white">
                    Get Premium
                  </button>
                  <button
                    onClick={()=>setSettingsOpen(true)}
                    title="è¨­å®š"
                    className={`group w-10 h-10 rounded-full flex items-center justify-center
                      ring-1 transition hover:scale-105
                      ${darkMode ? 'ring-white/20 hover:ring-white/30 bg-transparent text-white' : 'ring-black/10 hover:ring-black/20 bg-transparent text-gray-600'}`}
                  >
                    <Icon name="gear" className="w-6 h-6"/>
                  </button>
                  <AuthBar user={user}/>
                </div>
              </div>
            </div>

            <div className="max-w-7xl mx-auto px-4 pt-4">
              <StreakBadge diaries={diaries}/>
            </div>

            <PremiumModal
              open={showPremium}
              onClose={()=>setShowPremium(false)}
              onApplyCoupon={onApplyCoupon}
              onClearCoupon={onClearCoupon}
              onPurchase={onPurchase}
              membership={membership}
              user={user}
              appliedCoupon={appliedCoupon}
              selectedPlan={selectedPlan}
              setSelectedPlan={setSelectedPlan}
            />

            <SettingsPanel
              open={settingsOpen}
              onClose={()=>setSettingsOpen(false)}
              exportDiaries={exportDiaries}
              importDiaries={importDiaries}
              themeColor={themeColor}
              setThemeColor={setThemeColor}
              reminders={ReminderService.load()}
              onAddReminder={onAddReminder}
              onRemoveReminder={onRemoveReminder}
              profile={profile}
              isAdmin={isAdmin}
              onCreateCoupon={onCreateCoupon}
              onApplyCoupon={onApplyCoupon}
              membership={membership}
              onSetMembershipTier={onSetMembershipTier}
              onBackupToStorage={onBackupToStorage}
              onRestoreFromStorage={onRestoreFromStorage}
              todayShortcut={todayShortcut}
              toggleFavoritesOnly={toggleFavoritesOnly}
              favoritesOnly={favoritesOnly}
              darkMode={darkMode}
              setDarkMode={setDarkMode}
              user={user}
            />

            {renderMainContent()}
            
          </main>
        </div>
      );
    };

    /* ç§å¯†æª¢è¦–å™¨èˆ‡ä¸€èˆ¬æª¢è¦–å™¨ */
    const PrivateDiaryViewer = ({ currentDiary, user, profile, onEdit, onDelete, toggleFavorite }) => {
      const [inputPwd, setInputPwd] = React.useState('');
      const [unlocked, setUnlocked] = React.useState(false);
      const savedHash = (profile?.privatePasswordHash) || localStorage.getItem('privatePasswordHash') || '';
      const checkPassword = async ()=>{
        if(!savedHash){ alert('å°šæœªè¨­å®šç§å¯†æ—¥è¨˜å¯†ç¢¼'); return; }
        const hash = await sha256Hex(inputPwd);
        if(hash === savedHash){ setUnlocked(true); } else { alert('å¯†ç¢¼éŒ¯èª¤'); }
      };
      if(!unlocked){
        return (
          <div className="text-center py-20">
            <Icon name="lock" className="w-16 h-16 mx-auto mb-4 text-gray-400"/>
            <p className="text-gray-600 mb-4">é€™æ˜¯ä¸€ç¯‡ç§å¯†æ—¥è¨˜ï¼Œè«‹è¼¸å…¥å¯†ç¢¼ä»¥æŸ¥çœ‹å…§å®¹</p>
            <div className="flex justify-center gap-2">
              <input type="password" value={inputPwd} onChange={e=>setInputPwd(e.target.value)} className="border rounded-lg p-2"/>
              <button onClick={checkPassword} className="primary-bg text-white rounded-lg px-3">è§£é–</button>
            </div>
          </div>
        );
      }
      return <DiaryViewer currentDiary={currentDiary} onEdit={onEdit} onDelete={onDelete} toggleFavorite={toggleFavorite} />;
    };

    const DiaryViewer = ({ currentDiary, onEdit, onDelete, toggleFavorite }) => (
      <div className="space-y-6">
        <div className="flex items-start justify-between flex-wrap gap-4">
          <div>
            <div className="flex items-center gap-3 mb-4">
              <span className="text-5xl">{currentDiary.mood}</span>
              <span className="text-4xl">{currentDiary.weather}</span>
            </div>
            <h2 className="text-3xl font-bold mb-2">{currentDiary.title}</h2>
            <p className="text-sm text-gray-500">
              {(()=>{ const dt = toDate(currentDiary.createdAt); return dt ? dt.toLocaleString('zh-TW') : 'â€”'; })()}
            </p>
            {/* [âœ… ä¿®æ”¹] é¡¯ç¤ºåœ°é» + åœ°åœ–é€£çµï¼ˆå¦‚æœæœ‰åº§æ¨™ï¼‰ */}
            {currentDiary.location && (
              <p className="text-sm text-gray-500 mt-1 flex items-center gap-2">
                <Icon name="map-pin" className="w-4 h-4"/>
                <span>{currentDiary.location}</span>
                {(typeof currentDiary.locationLat === 'number' && typeof currentDiary.locationLng === 'number') && (
                  <a
                    className="underline text-blue-600"
                    href={`https://www.google.com/maps/search/?api=1&query=${currentDiary.locationLat},${currentDiary.locationLng}`}
                    target="_blank" rel="noopener noreferrer"
                  >
                    åœ¨åœ°åœ–é–‹å•Ÿ
                  </a>
                )}
              </p>
            )}
          </div>
          <div className="flex gap-2">
            {toggleFavorite && (
              <button onClick={()=>toggleFavorite(currentDiary.id)} className="p-2 hover:bg-gray-100 rounded-lg">
                <Icon name="heart" className={`w-6 h-6 ${currentDiary.isFavorite?'text-red-500':''}`} fill={currentDiary.isFavorite}/>
              </button>
            )}
            {onEdit && <button onClick={()=>onEdit(currentDiary)} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="edit" className="w-6 h-6"/></button>}
            {onDelete && <button onClick={()=>onDelete(currentDiary.id)} className="p-2 hover:bg-red-100 text-red-600 rounded-lg"><Icon name="trash" className="w-6 h-6"/></button>}
          </div>
        </div>
        {(currentDiary.tags||[]).length>0 && (
          <div className="flex gap-2 flex-wrap">
            {currentDiary.tags.map(t=><span key={t} className="bg-purple-200 text-purple-700 px-3 py-1 rounded-full">#{t}</span>)}
          </div>
        )}
        {currentDiary.images?.length>0 && (
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            {currentDiary.images.map((url,i)=><img key={i} src={url} className="w-full h-40 object-cover rounded-xl border"/>)}
          </div>
        )}
        <div className="prose max-w-none">
          <p className="text-lg whitespace-pre-wrap">{currentDiary.content}</p>
        </div>
        {currentDiary.isPrivate && (
          <div className="flex items-center gap-2 text-gray-500 text-sm">
            <Icon name="lock" className="w-4 h-4"/><span>é€™æ˜¯ä¸€ç¯‡ç§å¯†æ—¥è¨˜</span>
          </div>
        )}
      </div>
    );

    ReactDOM.render(<DiaryApp/>, document.getElementById('root'));
  </script>
</body>
</html>
