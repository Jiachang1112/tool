import React, { useState, useRef, useEffect } from 'react';
import { Upload, Image as ImageIcon, Sparkles, Download, Trash2, Plus, Smile, Zap, RefreshCw, AlertCircle } from 'lucide-react';

// --- API Helper Functions ---

const apiKey = ""; // API key will be injected by the environment

/**
 * Handles exponential backoff for API calls.
 */
async function fetchWithBackoff(url, options, maxRetries = 5) {
  let retries = 0;
  while (retries < maxRetries) {
    try {
      const response = await fetch(url, options);
      if (response.ok) {
        return response;
      }
      // If 5xx error or 429 (Too Many Requests), retry
      if (response.status >= 500 || response.status === 429) {
        throw new Error(`Server error: ${response.status}`);
      }
      // If client error (4xx), don't retry, just return response to be handled
      return response;
    } catch (error) {
      retries++;
      if (retries >= maxRetries) throw error;
      const delay = Math.pow(2, retries - 1) * 1000; // 1s, 2s, 4s, 8s, 16s
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
  throw new Error('Max retries exceeded');
}

/**
 * Calls Gemini API for Image-to-Image generation
 */
async function generateSticker(baseImageBase64, prompt, stylePrompt) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
  
  // Combine user prompt with style enforcement for Line stickers
  const fullPrompt = `Create a messaging app sticker (like Line or WhatsApp) based on the provided reference image.
  Action/Emotion: ${prompt}.
  Style: ${stylePrompt}.
  Requirements: White background, expressive character, vector art style, thick distinct outlines, isolated subject, consistent with the reference character's design features.`;

  // Remove header from base64 if present
  const base64Data = baseImageBase64.split(',')[1] || baseImageBase64;

  const payload = {
    contents: [{
      parts: [
        { text: fullPrompt },
        { 
          inlineData: { 
            mimeType: "image/png", // Assuming PNG/JPEG, API handles standard formats
            data: base64Data 
          } 
        }
      ]
    }],
    generationConfig: {
      responseModalities: ["IMAGE"], // Request specifically an image response
    }
  };

  try {
    const response = await fetchWithBackoff(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error?.message || 'API Error');
    }

    const result = await response.json();
    
    // Extract image from response
    // Logic: Look for inlineData in the response parts
    const generatedBase64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
    
    if (!generatedBase64) {
      throw new Error("No image generated.");
    }

    return `data:image/png;base64,${generatedBase64}`;

  } catch (error) {
    console.error("Generation failed:", error);
    throw error;
  }
}

// --- Components ---

const Header = () => (
  <header className="bg-green-500 text-white p-4 shadow-md sticky top-0 z-10">
    <div className="container mx-auto flex items-center justify-between">
      <div className="flex items-center gap-2">
        <Smile className="w-8 h-8 text-white fill-current opacity-90" />
        <h1 className="text-xl font-bold tracking-wide">StickerGen AI <span className="text-xs font-normal bg-green-600 px-2 py-1 rounded ml-2">Line 貼圖製作器</span></h1>
      </div>
    </div>
  </header>
);

const StickerCard = ({ sticker, onDelete }) => {
  return (
    <div className="relative group bg-white rounded-xl border-2 border-slate-100 shadow-sm overflow-hidden hover:shadow-md transition-all">
      <div className="aspect-square bg-[url('https://www.transparenttextures.com/patterns/white-diamond.png')] bg-slate-50 flex items-center justify-center p-4">
        {sticker.loading ? (
          <div className="flex flex-col items-center gap-2 text-slate-400 animate-pulse">
            <RefreshCw className="w-8 h-8 animate-spin" />
            <span className="text-xs font-medium">AI 繪製中...</span>
          </div>
        ) : sticker.error ? (
          <div className="flex flex-col items-center gap-2 text-red-400 text-center p-2">
            <AlertCircle className="w-8 h-8" />
            <span className="text-xs">{sticker.error}</span>
          </div>
        ) : (
          <img 
            src={sticker.url} 
            alt={sticker.prompt} 
            className="w-full h-full object-contain drop-shadow-md transition-transform duration-300 group-hover:scale-110" 
          />
        )}
      </div>
      
      {!sticker.loading && !sticker.error && (
        <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
          <button 
            onClick={() => {
              const link = document.createElement('a');
              link.href = sticker.url;
              link.download = `sticker_${sticker.id}.png`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }}
            className="p-2 bg-white rounded-full text-green-600 hover:bg-green-50 transition-colors"
            title="下載"
          >
            <Download className="w-5 h-5" />
          </button>
          <button 
            onClick={() => onDelete(sticker.id)}
            className="p-2 bg-white rounded-full text-red-500 hover:bg-red-50 transition-colors"
            title="刪除"
          >
            <Trash2 className="w-5 h-5" />
          </button>
        </div>
      )}
      
      <div className="p-3 border-t border-slate-100">
        <p className="text-xs text-slate-500 truncate font-medium">{sticker.prompt || "無標題"}</p>
      </div>
    </div>
  );
};

export default function App() {
  const [baseImage, setBaseImage] = useState(null);
  const [prompt, setPrompt] = useState("");
  const [stickers, setStickers] = useState([]);
  const [isGenerating, setIsGenerating] = useState(false);
  const [stylePreset, setStylePreset] = useState("Cute cartoon style, thick outlines, flat color");
  
  const fileInputRef = useRef(null);

  // Preset prompts for quick generation
  const quickPrompts = [
    "比讚 (Thumbs up)", "生氣翻桌 (Angry flipping table)", "哭泣 (Crying loudly)", 
    "充滿愛意 (In love with hearts)", "OK手勢 (OK sign)", "問號 (Confused)",
    "睡覺 (Sleeping)", "慶祝 (Party celebration)"
  ];

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setBaseImage(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleGenerate = async () => {
    if (!baseImage) {
      alert("請先上傳角色圖片！");
      return;
    }
    if (!prompt.trim()) {
      alert("請輸入貼圖的提示詞（例如：生氣、開心）");
      return;
    }

    const newId = Date.now();
    
    // Add a placeholder card
    setStickers(prev => [{
      id: newId,
      url: null,
      prompt: prompt,
      loading: true,
      error: null
    }, ...prev]);

    setIsGenerating(true);
    setPrompt(""); // Clear input

    try {
      const imageUrl = await generateSticker(baseImage, prompt, stylePreset);
      
      setStickers(prev => prev.map(s => 
        s.id === newId 
          ? { ...s, url: imageUrl, loading: false } 
          : s
      ));
    } catch (error) {
      setStickers(prev => prev.map(s => 
        s.id === newId 
          ? { ...s, loading: false, error: "生成失敗，請稍後重試" } 
          : s
      ));
    } finally {
      setIsGenerating(false);
    }
  };

  const handleDelete = (id) => {
    setStickers(prev => prev.filter(s => s.id !== id));
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      <Header />

      <main className="container mx-auto p-4 md:p-6 lg:p-8 max-w-6xl">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* Left Panel: Controls */}
          <div className="lg:col-span-1 space-y-6">
            
            {/* 1. Upload Section */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">
                <span className="flex items-center justify-center w-6 h-6 rounded-full bg-green-500 text-white text-sm">1</span>
                上傳角色原圖
              </h2>
              
              <div 
                className={`relative aspect-square rounded-xl border-2 border-dashed transition-all cursor-pointer overflow-hidden flex flex-col items-center justify-center text-center
                  ${baseImage ? 'border-green-400 bg-green-50' : 'border-slate-300 hover:border-green-400 hover:bg-slate-50'}`}
                onClick={() => fileInputRef.current.click()}
              >
                {baseImage ? (
                  <>
                    <img src={baseImage} alt="Base Character" className="w-full h-full object-contain p-2" />
                    <div className="absolute inset-0 bg-black/40 opacity-0 hover:opacity-100 flex items-center justify-center transition-opacity text-white font-medium">
                      點擊更換圖片
                    </div>
                  </>
                ) : (
                  <div className="p-6 text-slate-400">
                    <Upload className="w-12 h-12 mx-auto mb-3 text-slate-300" />
                    <p className="text-sm font-medium text-slate-600">點擊上傳角色圖片</p>
                    <p className="text-xs mt-2 text-slate-400">建議：背景乾淨、特徵明顯的圖片</p>
                  </div>
                )}
                <input 
                  type="file" 
                  ref={fileInputRef} 
                  onChange={handleImageUpload} 
                  accept="image/*" 
                  className="hidden" 
                />
              </div>
            </div>

            {/* 2. Generation Controls */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 relative overflow-hidden">
               {/* Disabled overlay if no image */}
               {!baseImage && (
                <div className="absolute inset-0 bg-white/60 backdrop-blur-[1px] z-10 flex items-center justify-center text-slate-500 font-medium">
                  請先完成步驟 1
                </div>
              )}

              <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">
                <span className="flex items-center justify-center w-6 h-6 rounded-full bg-green-500 text-white text-sm">2</span>
                設計貼圖
              </h2>

              <div className="space-y-4">
                <div>
                  <label className="block text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">風格設定</label>
                  <select 
                    value={stylePreset}
                    onChange={(e) => setStylePreset(e.target.value)}
                    className="w-full p-2.5 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-green-500 outline-none bg-slate-50"
                  >
                    <option value="Cute cartoon style, thick outlines, flat color, sticker art">標準可愛 (Cartoon)</option>
                    <option value="Hand drawn sketch style, rough lines, artistic, cute">手繪塗鴉 (Sketch)</option>
                    <option value="3D render, clay style, soft lighting, cute toy">3D 黏土風 (Clay)</option>
                    <option value="Retro manga style, halftone dots, expressive">復古漫畫 (Manga)</option>
                  </select>
                </div>

                <div>
                  <label className="block text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">貼圖動作 / 表情</label>
                  <div className="flex gap-2">
                    <input 
                      type="text" 
                      value={prompt}
                      onChange={(e) => setPrompt(e.target.value)}
                      placeholder="例如：生氣、吃西瓜、說晚安..."
                      onKeyDown={(e) => e.key === 'Enter' && handleGenerate()}
                      className="flex-1 p-3 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-green-500 outline-none"
                    />
                    <button 
                      onClick={handleGenerate}
                      disabled={isGenerating || !prompt}
                      className="bg-green-500 hover:bg-green-600 disabled:bg-slate-300 disabled:cursor-not-allowed text-white p-3 rounded-lg transition-colors flex items-center justify-center min-w-[3rem]"
                    >
                      {isGenerating ? <RefreshCw className="w-5 h-5 animate-spin" /> : <Sparkles className="w-5 h-5" />}
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">快速選擇</label>
                  <div className="flex flex-wrap gap-2">
                    {quickPrompts.map((q) => (
                      <button 
                        key={q}
                        onClick={() => setPrompt(q)}
                        className="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-full transition-colors border border-slate-200"
                      >
                        {q.split(' ')[0]}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Right Panel: Results */}
          <div className="lg:col-span-2 space-y-4">
            <div className="flex items-center justify-between">
              <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                <ImageIcon className="w-6 h-6 text-green-500" />
                貼圖預覽區
                <span className="text-sm font-normal text-slate-500 ml-2">({stickers.length})</span>
              </h2>
              {stickers.length > 0 && (
                <button 
                  onClick={() => setStickers([])} 
                  className="text-sm text-red-400 hover:text-red-500 font-medium px-3 py-1 rounded hover:bg-red-50 transition-colors"
                >
                  全部清除
                </button>
              )}
            </div>

            {stickers.length === 0 ? (
              <div className="bg-white rounded-2xl border-2 border-dashed border-slate-200 p-12 text-center h-[500px] flex flex-col items-center justify-center text-slate-400">
                <div className="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                  <Zap className="w-10 h-10 text-slate-300" />
                </div>
                <p className="text-lg font-medium text-slate-600">還沒有貼圖喔！</p>
                <p className="max-w-xs mx-auto mt-2">在左側上傳角色圖片並輸入提示詞，AI 就會為你生成一系列專屬貼圖。</p>
              </div>
            ) : (
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {stickers.map((sticker) => (
                  <StickerCard key={sticker.id} sticker={sticker} onDelete={handleDelete} />
                ))}
                
                {/* Easy Add Button in Grid */}
                <button 
                  onClick={() => document.querySelector('input[type="text"]')?.focus()}
                  className="aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-green-400 hover:bg-green-50 transition-all flex flex-col items-center justify-center text-slate-400 hover:text-green-500 gap-2 group"
                >
                  <div className="w-10 h-10 rounded-full bg-slate-100 group-hover:bg-green-100 flex items-center justify-center transition-colors">
                    <Plus className="w-6 h-6" />
                  </div>
                  <span className="text-xs font-medium">製作更多</span>
                </button>
              </div>
            )}
          </div>

        </div>
      </main>
    </div>
  );
}
